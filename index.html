<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Electrical Boxes & Covers Estimator – NEC 2023 Compliant with Box Fill Calculations">
    <meta name="author" content="AestimareDesign">
    <title>Professional Electrical Boxes & Covers Estimator | NEC 2023 Compliant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    :root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --success: #27ae60;
    --warning: #e67e22;
    --danger: #e0392b;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --text-dark: #2c3e50;
    --text-medium: #5d6d7e;
    --text-light: #7f8c8d;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: var(--text-dark);
    background-color: #f8f9fa;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

header {
    background: var(--primary);
    color: white;
    padding: 1rem 0;
    margin-bottom: 2rem;
    border-radius: 8px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
}

h1 {
    font-size: 2rem;
    font-weight: 600;
}

.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--secondary);
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.85rem;
}

.btn:hover, .btn:focus {
    opacity: 0.9;
    transform: translateY(-1px);
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
}

.calculator-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 2rem;
}

@media (max-width: 1024px) {
    .calculator-grid {
    grid-template-columns: 1fr;
    }
}

.input-section, .output-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--light);
    color: var(--primary);
}

.input-group {
    margin-bottom: 1rem;
}

.input-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

.input-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

.input-row-dynamic {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr auto;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-dark);
}

input, select, textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

textarea {
    min-height: 80px;
    resize: vertical;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.work-item {
    background: var(--light);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    border-left: 4px solid var(--secondary);
}

.work-item-title {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.bill-of-quantity-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.bill-of-quantity-table th,
.bill-of-quantity-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.bill-of-quantity-table th {
    background: var(--primary);
    color: white;
    font-weight: 600;
}

.bill-of-quantity-table tr:hover {
    background-color: #f5f5f5;
}

.total-row {
    font-weight: 600;
    background-color: var(--light) !important;
}

.text-right {
    text-align: right;
}

.text-center {
    text-align: center;
}

.cost-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 1rem;
}

.cost-card {
    background: white;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-top: 4px solid var(--secondary);
}

.cost-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
    margin: 10px 0;
}

.validation-error {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 5px;
    display: none;
}

.tab-container {
    margin-bottom: 1rem;
}

.tabs {
    display: flex;
    border-bottom: 1px solid #ddd;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.tab.active {
    border-bottom-color: var(--secondary);
    color: var(--secondary);
    font-weight: 600;
}

.tab.focus {
    outline: 2px solid var(--secondary);
    outline-offset: -2px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.unit-label {
    font-size: 0.8rem;
    color: var(--text-medium);
    margin-top: 2px;
}

.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: var(--dark);
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

.crew-sizing {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--success);
}

.crew-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.crew-option {
    background: white;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
}

.bill-of-quantity-table td:nth-child(3),
.bill-of-quantity-table td:nth-child(5),
.bill-of-quantity-table td:nth-child(6),
.bill-of-quantity-table td:nth-child(7) { text-align: right; }
.bill-of-quantity-table td:nth-child(1),
.bill-of-quantity-table td:nth-child(4) { text-align: center; }

.hidden {
    display: none;
}

.remove-btn {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 5px 10px;
    font-size: 0.85rem;
}

.remove-btn:hover, .remove-btn:focus {
    opacity: 0.9;
    outline: 2px solid var(--danger);
    outline-offset: 2px;
}

.input-error {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.2) !important;
}

.error-message {
    color: var(--danger);
    font-size: 0.75rem;
    margin-top: 3px;
    display: none;
}

/* NEC Box Fill Styles */
.nec-box-fill {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
}

.nec-result {
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-weight: 600;
}

.nec-pass {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    color: #2e7d32;
}

.nec-fail {
    background: #ffebee;
    border: 1px solid #f44336;
    color: #c62828;
}

.nec-warning {
    background: #fff3e0;
    border: 1px solid #ff9800;
    color: #ef6c00;
}

.conductor-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 0.9em;
}

.conductor-table th, .conductor-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.conductor-table th {
    background: #f5f5f5;
}

/* Help section backgrounds */
.help-section {
    margin-bottom: 25px;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.how-to-use {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 4px solid #2196f3;
}

.calculation-formulas {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 4px solid #4caf50;
}

.standard-sizes {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border-left: 4px solid #ff9800;
}

.step-guide p {
    margin-bottom: 10px;
    display: flex;
    align-items: flex-start;
}

.step-number {
    display: inline-block;
    background: var(--secondary);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    margin-right: 10px;
    flex-shrink: 0;
}

.formula-box, .reference-box {
    padding: 15px;
    background: rgba(255,255,255,0.7);
    border-radius: 6px;
    margin-top: 10px;
}

.formula-box h4, .reference-box h4 {
    margin-top: 15px;
    margin-bottom: 8px;
    color: var(--primary);
}

.formula-box p, .reference-box ul {
    margin-bottom: 8px;
    color: var(--text-dark);
}

.reference-box ul {
    padding-left: 20px;
}

/* Procurement styles */
.procurement-note {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-size: 0.9em;
}

/* Scope checklist */
.scope-checklist {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
}

.checklist-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 8px;
}

.checklist-item input {
    width: auto;
    margin-right: 10px;
    margin-top: 3px;
}

/* Test cases */
.test-cases {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border-left: 4px solid #9c27b0;
}

.test-case {
    background: rgba(255,255,255,0.7);
    padding: 15px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #7b1fa2;
}

/* Accessibility improvements */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: var(--secondary);
    color: white;
    padding: 8px;
    z-index: 100;
    text-decoration: none;
    border-radius: 4px;
}

.skip-link:focus {
    top: 6px;
}

/* Focus indicators */
*:focus {
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
    --primary: #000000;
    --secondary: #0000ff;
    --success: #008000;
    --warning: #ffa500;
    --danger: #ff0000;
    --text-dark: #000000;
    --text-medium: #000000;
    --text-light: #000000;
}

.unit-label {
    font-weight: bold;
}
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    }
    }
    </style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="container">
    <header>
    <div class="header-content">
    <h1>Professional Electrical Boxes & Covers Estimator</h1>
    <div class="controls">
    <button class="btn btn-success" id="exportPdfBtn" aria-label="Export results as PDF document">Export PDF</button>
    <button class="btn btn-success" id="exportExcelBtn" aria-label="Export results as Excel spreadsheet">Export Excel</button>
    <button class="btn btn-danger" id="resetBtn" aria-label="Reset all inputs and calculations">Reset</button>
    </div>
    </div>
</header>

<main id="main-content">
    <div class="calculator-grid">
    <div class="input-section">
    <h2 class="section-title">Project Inputs</h2>

    <div class="input-group">
    <label for="projectName">Project Name</label>
    <input type="text" id="projectName" placeholder="Enter project name"
    value="Commercial Fit-Out Project" aria-required="true">
    <div class="error-message" id="projectNameError">Project name is required</div>
    </div>

    <div class="input-group">
    <label for="bidNumber">Bid/Proposal Number</label>
    <input type="text" id="bidNumber" placeholder="BID-2024-001" value="BID-2024-001">
    </div>

    <div class="input-group">
    <label for="clientName">Client Name</label>
    <input type="text" id="clientName" placeholder="Enter client name" value="ABC Development Corporation">
    </div>

    <div class="input-group">
    <label for="projectLocation">Project Location</label>
    <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines" value="Makati City, Philippines">
    </div>

    <div class="input-group">
    <label for="preparedBy">Prepared By</label>
    <input type="text" id="preparedBy" placeholder="Enter preparer name" value="John Smith, Licensed Electrical Engineer">
    </div>

    <div class="input-group">
    <label for="projectDate">Date</label>
    <input type="date" id="projectDate">
</div>

<div class="tab-container">
    <div class="tabs" role="tablist" aria-label="Project input sections">
    <div class="tab active" role="tab" aria-selected="true" aria-controls="general-tab" data-tab="general" id="tab-general" tabindex="0">General Parameters</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="boxes-tab" data-tab="boxes" id="tab-boxes" tabindex="0">Boxes & Covers</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="nec-tab" data-tab="nec" id="tab-nec" tabindex="0">NEC Compliance</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="scope-tab" data-tab="scope" id="tab-scope" tabindex="0">Scope & Labor</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="help-tab" data-tab="help" id="tab-help" tabindex="0">Help & Reference</div>
    </div>

<div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
    <div class="input-row">
    <div class="input-group">
    <label for="wallArea" class="tooltip">Total Wall Area (m²)<span class="tooltiptext">Total wall area where boxes will be installed</span></label>
    <input type="number" id="wallArea" value="250" min="1" aria-describedby="wallAreaDesc">
    <div class="error-message" id="wallAreaError">Wall area must be positive</div>
    <div class="unit-label">m²</div>
    <div id="wallAreaDesc" class="sr-only">Total wall area where boxes will be installed</div>
    </div>
    <div class="input-group">
    <label for="density" class="tooltip">Outlets per m²<span class="tooltiptext">Number of electrical outlets per square meter</span></label>
    <input type="number" id="density" value="0.6" step="0.1" min="0" aria-describedby="densityDesc">
    <div class="error-message" id="densityError">Density must be positive</div>
    <div id="densityDesc" class="sr-only">Number of electrical outlets per square meter</div>
    </div>
    <div class="input-group">
    <label for="wastage" class="tooltip">Wastage (%)<span class="tooltiptext">Percentage of additional materials for wastage</span></label>
    <input type="number" id="wastage" value="10" min="0" max="30" aria-describedby="wastageDesc">
    <div class="error-message" id="wastageError">Wastage must be between 0-30%</div>
    <div id="wastageDesc" class="sr-only">Percentage of additional materials for wastage</div>
    </div>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="currency">Currency</label>
    <select id="currency" aria-describedby="currencyDesc">
    <option value="PHP">Philippine Peso (PHP)</option>
    <option value="USD">US Dollar ($)</option>
    <option value="EUR">Euro (€)</option>
    <option value="JPY">Japanese Yen (¥)</option>
</select>
<div id="currencyDesc" class="sr-only">Select the currency for cost calculations</div>
</div>
<div class="input-group">
    <label for="overheadRate" class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
    <input type="number" id="overheadRate" value="18" step="0.1" min="0" max="100" aria-describedby="overheadRateDesc">
    <div class="error-message" id="overheadRateError">Overhead rate must be between 0-100%</div>
    <div id="overheadRateDesc" class="sr-only">Percentage for general overhead costs</div>
</div>
<div class="input-group">
    <label for="profitMarginRate" class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
    <input type="number" id="profitMarginRate" value="22" step="0.1" min="0" max="100" aria-describedby="profitMarginDesc">
    <div class="error-message" id="profitMarginError">Profit margin must be between 0-100%</div>
    <div id="profitMarginDesc" class="sr-only">Desired profit margin percentage</div>
</div>
</div>
</div>
<div class="tab-content" id="boxes-tab" role="tabpanel" aria-labelledby="tab-boxes">
    <div class="work-item">
    <div class="work-item-title">
    <span>Box Types & Distribution</span>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="pctJunc" class="tooltip">Junction Box (%)<span class="tooltiptext">Percentage of junction boxes (4x4")</span></label>
    <input type="number" id="pctJunc" value="30" min="0" max="100" aria-describedby="pctJuncDesc">
    <div id="pctJuncDesc" class="sr-only">Percentage of junction boxes</div>
    </div>
    <div class="input-group">
    <label for="pctUtil" class="tooltip">Utility Box (%)<span class="tooltiptext">Percentage of utility boxes</span></label>
    <input type="number" id="pctUtil" value="35" min="0" max="100" aria-describedby="pctUtilDesc">
    <div id="pctUtilDesc" class="sr-only">Percentage of utility boxes</div>
    </div>
    <div class="input-group">
    <label for="pctSq" class="tooltip">Square Box (%)<span class="tooltiptext">Percentage of square boxes</span></label>
    <input type="number" id="pctSq" value="15" min="0" max="100" aria-describedby="pctSqDesc">
    <div id="pctSqDesc" class="sr-only">Percentage of square boxes</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="pctPull" class="tooltip">Pull Box (%)<span class="tooltiptext">Percentage of pull boxes (8x8")</span></label>
    <input type="number" id="pctPull" value="5" min="0" max="100" aria-describedby="pctPullDesc">
    <div id="pctPullDesc" class="sr-only">Percentage of pull boxes (8x8")</div>
    </div>
    <div class="input-group">
    <label for="pctGutter" class="tooltip">Gutter (%)<span class="tooltiptext">Percentage of gutters</span></label>
    <input type="number" id="pctGutter" value="3" min="0" max="100" aria-describedby="pctGutterDesc">
    <div id="pctGutterDesc" class="sr-only">Percentage of gutters</div>
    </div>
    <div class="input-group">
    <label for="pctWire4" class="tooltip">Wireway 4x4" (%)<span class="tooltiptext">Percentage of 4x4 wireways</span></label>
    <input type="number" id="pctWire4" value="7" min="0" max="100" aria-describedby="pctWire4Desc">
    <div id="pctWire4Desc" class="sr-only">Percentage of 4x4 wireways</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="pctWire6" class="tooltip">Wireway 6x6" (%)<span class="tooltiptext">Percentage of 6x6 wireways</span></label>
    <input type="number" id="pctWire6" value="3" min="0" max="100" aria-describedby="pctWire6Desc">
    <div id="pctWire6Desc" class="sr-only">Percentage of 6x6 wireways</div>
    </div>
    <div class="input-group">
    <label for="pctWire8" class="tooltip">Wireway 8x8" (%)<span class="tooltiptext">Percentage of 8x8 wireways</span></label>
    <input type="number" id="pctWire8" value="2" min="0" max="100" aria-describedby="pctWire8Desc">
    <div id="pctWire8Desc" class="sr-only">Percentage of 8x8 wireways</div>
    </div>
    <div class="input-group">
    <label>Total Distribution</label>
    <input type="text" id="distributionTotal" value="100%" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    <div class="error-message" id="distributionError"></div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Unit Costs & Procurement</span>
    </div>
    <div class="procurement-note">
    <strong>Procurement Notes:</strong> Quantities will be rounded up to nearest standard packaging (cartons of 10 for boxes, 25 for covers, 100 for nipples)
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costJunc" class="tooltip">Junction Box<span class="tooltiptext">Cost per junction box (4x4")</span></label>
    <input type="number" id="costJunc" value="55" min="0" step="0.01" aria-describedby="costJuncDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costJuncDesc" class="sr-only">Cost per junction box (4x4")</div>
    </div>
    <div class="input-group">
    <label for="costUtil" class="tooltip">Utility Box<span class="tooltiptext">Cost per utility box</span></label>
    <input type="number" id="costUtil" value="65" min="0" step="0.01" aria-describedby="costUtilDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costUtilDesc" class="sr-only">Cost per utility box</div>
    </div>
    <div class="input-group">
    <label for="costSq" class="tooltip">Square Box<span class="tooltiptext">Cost per square box</span></label>
    <input type="number" id="costSq" value="60" min="0" step="0.01" aria-describedby="costSqDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costSqDesc" class="sr-only">Cost per square box</div>
    </div>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="costPull" class="tooltip">Pull Box<span class="tooltiptext">Cost per pull box (8x8")</span></label>
    <input type="number" id="costPull" value="125" min="0" step="0.01" aria-describedby="costPullDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costPullDesc" class="sr-only">Cost per pull box (8x8")</div>
    </div>
    <div class="input-group">
    <label for="costGutter" class="tooltip">Gutter<span class="tooltiptext">Cost per gutter</span></label>
    <input type="number" id="costGutter" value="220" min="0" step="0.01" aria-describedby="costGutterDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costGutterDesc" class="sr-only">Cost per gutter</div>
    </div>
    <div class="input-group">
    <label for="costNip" class="tooltip">Closed Nipple<span class="tooltiptext">Cost per closed nipple</span></label>
    <input type="number" id="costNip" value="18" min="0" step="0.01" aria-describedby="costNipDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costNipDesc" class="sr-only">Cost per closed nipple</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costWire4" class="tooltip">Wireway 4x4"<span class="tooltiptext">Cost per 4x4 wireway</span></label>
    <input type="number" id="costWire4" value="160" min="0" step="0.01" aria-describedby="costWire4Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire4Desc" class="sr-only">Cost per 4x4 wireway</div>
    </div>
    <div class="input-group">
    <label for="costWire6" class="tooltip">Wireway 6x6"<span class="tooltiptext">Cost per 6x6 wireway</span></label>
    <input type="number" id="costWire6" value="265" min="0" step="0.01" aria-describedby="costWire6Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire6Desc" class="sr-only">Cost per 6x6 wireway</div>
    </div>
    <div class="input-group">
    <label for="costWire8" class="tooltip">Wireway 8x8"<span class="tooltiptext">Cost per 8x8 wireway</span></label>
    <input type="number" id="costWire8" value="375" min="0" step="0.01" aria-describedby="costWire8Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire8Desc" class="sr-only">Cost per 8x8 wireway</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costCover" class="tooltip">Covers<span class="tooltiptext">Cost per cover</span></label>
    <input type="number" id="costCover" value="25" min="0" step="0.01" aria-describedby="costCoverDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costCoverDesc" class="sr-only">Cost per cover</div>
    </div>
    </div>
    </div>
    </div>
    <div class="tab-content" id="nec-tab" role="tabpanel" aria-labelledby="tab-nec">
    <div class="work-item">
    <div class="work-item-title">
    <span>NEC 314.16 Box Fill Calculations</span>
    </div>
    <p><strong>Standard Box Fill Calculation (NEC 2023 314.16)</strong></p>
    
    <div class="input-row">
    <div class="input-group">
    <label for="conductorSize" class="tooltip">Conductor Size<span class="tooltiptext">Select the wire gauge being used</span></label>
    <select id="conductorSize" aria-describedby="conductorSizeDesc">
    <option value="14">14 AWG (2.08 mm²)</option>
    <option value="12" selected>12 AWG (3.31 mm²)</option>
    <option value="10">10 AWG (5.26 mm²)</option>
    <option value="8">8 AWG (8.37 mm²)</option>
    </select>
    <div id="conductorSizeDesc" class="sr-only">Select the wire gauge being used</div>
    </div>
    <div class="input-group">
    <label for="currentConductors" class="tooltip">Current-Carrying Conductors<span class="tooltiptext">Number of current-carrying conductors in the box</span></label>
    <input type="number" id="currentConductors" value="6" min="0" aria-describedby="currentConductorsDesc">
    <div id="currentConductorsDesc" class="sr-only">Number of current-carrying conductors in the box</div>
    </div>
    <div class="input-group">
    <label for="groundingConductors" class="tooltip">Grounding Conductors<span class="tooltiptext">Number of grounding conductors in the box</span></label>
    <input type="number" id="groundingConductors" value="2" min="0" aria-describedby="groundingConductorsDesc">
    <div id="groundingConductorsDesc" class="sr-only">Number of grounding conductors in the box</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="devicesCount" class="tooltip">Devices (Switches/Receptacles)<span class="tooltiptext">Number of devices (switches or receptacles) in the box</span></label>
    <input type="number" id="devicesCount" value="2" min="0" aria-describedby="devicesCountDesc">
    <div id="devicesCountDesc" class="sr-only">Number of devices (switches or receptacles) in the box</div>
    </div>
    <div class="input-group">
    <label for="cableClamps" class="tooltip">Cable Clamps<span class="tooltiptext">Number of cable clamps in the box</span></label>
    <input type="number" id="cableClamps" value="2" min="0" aria-describedby="cableClampsDesc">
    <div id="cableClampsDesc" class="sr-only">Number of cable clamps in the box</div>
    </div>
    <div class="input-group">
    <label for="pigtails" class="tooltip">Pigtails<span class="tooltiptext">Number of wire pigtails not entering/leaving the box</span></label>
    <input type="number" id="pigtails" value="2" min="0" aria-describedby="pigtailsDesc">
    <div id="pigtailsDesc" class="sr-only">Number of wire pigtails not entering/leaving the box</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="boxVolume" class="tooltip">Box Volume (cu. in.)<span class="tooltiptext">Volume of the electrical box in cubic inches</span></label>
    <input type="number" id="boxVolume" value="18" min="0" step="0.1" aria-describedby="boxVolumeDesc">
    <div class="unit-label">cu. in.</div>
    <div id="boxVolumeDesc" class="sr-only">Volume of the electrical box in cubic inches</div>
    </div>
    <div class="input-group">
    <label for="safetyFactor" class="tooltip">Design Safety Factor (%)<span class="tooltiptext">Additional capacity for future modifications</span></label>
    <input type="number" id="safetyFactor" value="20" min="0" max="50" aria-describedby="safetyFactorDesc">
    <div class="unit-label">%</div>
    <div id="safetyFactorDesc" class="sr-only">Additional capacity for future modifications</div>
    </div>
    </div>
    <div class="nec-box-fill">
    <h4>NEC Box Fill Calculation Result</h4>
    <div id="necResult" class="nec-result">Fill calculation will appear here</div>
    <div id="necDetails"></div>
    </div>
    </div>
    </div>
    <div class="tab-content" id="scope-tab" role="tabpanel" aria-labelledby="tab-scope">
    <div class="work-item">
    <div class="work-item-title">
    <span>Scope of Work Definition</span>
    </div>
    <div class="scope-checklist">
    <h4>What's Included:</h4>
    <ul style="padding-left: 20px; margin-bottom: 15px;">
    <li>Supply and installation of all electrical boxes, covers, and accessories</li>
    <li>Box mounting and securing per NEC requirements</li>
    <li>Installation of necessary nipples and connectors</li>
    <li>Coordination with other trades for proper placement</li>
    <li>Compliance with local building codes and standards</li>
    </ul>
    <h4>What's Not Included:</h4>
    <ul style="padding-left: 20px;">
    <li>Wiring and terminations (by electrical team)</li>
    <li>Wall patching and finishing (by finishing team)</li>
    <li>Specialty boxes not listed in standard catalog</li>
    <li>Demolition of existing boxes or structures</li>
    <li>Permit fees and inspections</li>
    </ul>
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Labor & Crew Parameters</span>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label for="laborRate" class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for electrical workers</span></label>
    <input type="number" id="laborRate" value="85" min="0" step="0.01" aria-describedby="laborRateDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="laborRateDesc" class="sr-only">Hourly rate for electrical workers</div>
    </div>
    <div class="input-group">
    <label for="productivity" class="tooltip">Productivity (boxes/hour)<span class="tooltiptext">Number of boxes installed per hour per worker</span></label>
    <input type="number" id="productivity" value="4.5" min="0.1" step="0.1" aria-describedby="productivityDesc">
    <div class="unit-label">boxes/hour</div>
    <div id="productivityDesc" class="sr-only">Number of boxes installed per hour per worker</div>
    </div>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label for="crewSize" class="tooltip">Crew Size<span class="tooltiptext">Number of workers in the installation crew</span></label>
    <input type="number" id="crewSize" value="3" min="1" aria-describedby="crewSizeDesc">
    <div id="crewSizeDesc" class="sr-only">Number of workers in the installation crew</div>
    </div>
    <div class="input-group">
    <label for="workHours" class="tooltip">Daily Work Hours<span class="tooltiptext">Standard work hours per day</span></label>
    <input type="number" id="workHours" value="8" min="1" max="12" aria-describedby="workHoursDesc">
    <div class="unit-label">hours/day</div>
    <div id="workHoursDesc" class="sr-only">Standard work hours per day</div>
    </div>
    </div>
    <div class="crew-sizing">
    <h4>Crew Sizing Options</h4>
    <div class="crew-options">
    <div class="crew-option">
    <h5>Standard Crew</h5>
    <p>2 Electricians</p>
    <p>1 Helper</p>
    </div>
    <div class="crew-option">
    <h5>Small Crew</h5>
    <p>1 Electrician</p>
    <p>1 Helper</p>
    </div>
    <div class="crew-option">
    <h5>Large Crew</h5>
    <p>3 Electricians</p>
    <p>2 Helpers</p>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div class="tab-content" id="help-tab" role="tabpanel" aria-labelledby="tab-help">
    <div class="help-section how-to-use">
    <h3>How to Use This Estimator</h3>
    <div class="step-guide">
    <p><span class="step-number">1</span> Enter project details and general parameters in the General tab</p>
    <p><span class="step-number">2</span> Configure box distribution percentages and unit costs in the Boxes & Covers tab</p>
    <p><span class="step-number">3</span> Verify NEC compliance using the Box Fill Calculator in the NEC Compliance tab</p>
    <p><span class="step-number">4</span> Review scope of work and adjust labor parameters in the Scope & Labor tab</p>
    <p><span class="step-number">5</span> Click "Calculate" to generate your professional estimate</p>
    <p><span class="step-number">6</span> Export results as PDF or Excel for your proposal</p>
    </div>
    </div>
    <div class="help-section calculation-formulas">
    <h3>Calculation Formulas</h3>
    <div class="formula-box">
    <h4>Total Boxes Calculation</h4>
    <p><strong>Total Outlets = Wall Area × Outlet Density</strong></p>
    <p>Example: 250 m² × 0.6 outlets/m² = 150 outlets</p>
    <h4>Material Cost Calculation</h4>
    <p><strong>Material Cost = (Quantity × Unit Cost) × (1 + Wastage%)</strong></p>
    <h4>Labor Cost Calculation</h4>
    <p><strong>Labor Hours = Total Boxes ÷ (Productivity Rate × Crew Size)</strong></p>
    <p><strong>Labor Cost = Labor Hours × Labor Rate</strong></p>
    <h4>Total Cost Calculation</h4>
    <p><strong>Direct Cost = Material Cost + Labor Cost</strong></p>
    <p><strong>Overhead = Direct Cost × Overhead Rate</strong></p>
    <p><strong>Profit = (Direct Cost + Overhead) × Profit Margin</strong></p>
    <p><strong>Total Cost = Direct Cost + Overhead + Profit</strong></p>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Standard Box Volumes (cubic inches)</h3>
    <div class="reference-box">
    <ul>
    <li>Standard Switch Box: 18.0 cu. in.</li>
    <li>Deep Switch Box: 22.5 cu. in.</li>
    <li>4" Square Box (1-1/2" deep): 21.0 cu. in.</li>
    <li>4" Square Box (2-1/8" deep): 30.3 cu. in.</li>
    <li>4" Square Box (2-1/2" deep): 42.0 cu. in.</li>
    <li>4-11/16" Square Box (1-1/2" deep): 31.5 cu. in.</li>
    <li>4-11/16" Square Box (2-1/8" deep): 42.5 cu. in.</li>
    <li>Octagon Box (standard): 18.0 cu. in.</li>
    <li>Octagon Box (deep): 25.5 cu. in.</li>
    </ul>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Volume Allowances per NEC 314.16</h3>
    <div class="reference-box">
    <ul>
    <li>Conductor Volume Allowances:
    <ul style="padding-left: 20px;">
    <li>18 AWG: 1.5 cu. in.</li>
    <li>16 AWG: 1.75 cu. in.</li>
    <li>14 AWG: 2.0 cu. in.</li>
    <li>12 AWG: 2.25 cu. in.</li>
    <li>10 AWG: 2.5 cu. in.</li>
    <li>8 AWG: 3.0 cu. in.</li>
    <li>6 AWG: 5.0 cu. in.</li>
    </ul>
    </li>
    <li>Device (yoke) allowance: 2 × conductor volume</li>
    <li>Grounding conductors: 1 × conductor volume (all grounds count as one)</li>
    <li>Cable clamps: 1 × conductor volume</li>
    <li>Pigtails: 1 × conductor volume (each)</li>
    </ul>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Standard Procurement Packaging</h3>
    <div class="reference-box">
    <ul>
    <li>Standard Boxes: Cartons of 10 units</li>
    <li>Covers: Cartons of 25 units</li>
    <li>Nipples: Boxes of 100 units</li>
    <li>Gutters: Individual units</li>
    <li>Wireways: Individual units</li>
    </ul>
    </div>
    </div>
    <div class="help-section test-cases">
    <h3>Test Cases & Validation</h3>
    <div class="test-case">
    <h4>Test Case 1: Standard Commercial Office</h4>
    <p>Wall Area: 250 m², Density: 0.6 outlets/m²</p>
    <p>Expected: ~150 outlets, Material Cost: ~PHP 12,000</p>
    </div>
    <div class="test-case">
    <h4>Test Case 2: High-Density Retail</h4>
    <p>Wall Area: 150 m², Density: 1.2 outlets/m²</p>
    <p>Expected: ~180 outlets, Material Cost: ~PHP 14,400</p>
    </div>
    </div>
    </div>
    </div>
    <div class="input-group" style="margin-top: 20px;">
    <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; font-size: 1.1rem;">Calculate</button>
    </div>
    </div>
    <div class="output-section">
    <h2 class="section-title">Estimate Results</h2>
    <div id="necComplianceWarning" class="nec-result nec-warning hidden">
    <strong>NEC Compliance Warning:</strong> Some box types may not meet NEC requirements. Review details below.
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Bill of Quantities</span>
    </div>
    <table class="bill-of-quantity-table" id="billOfQuantity">
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="7" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td id="totalMaterialCost" class="text-right">-</td>
    <td id="totalLaborCost" class="text-right">-</td>
    </tr>
    </tfoot>
    </table>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Cost Breakdown</span>
    </div>
    <div class="cost-breakdown">
    <div class="cost-card">
    <div>Material Cost</div>
    <div id="materialCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    <div class="cost-card">
    <div>Labor Cost</div>
    <div id="laborCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    <div class="cost-card">
    <div>Direct Cost</div>
    <div id="directCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    <div class="cost-card">
    <div>Overhead</div>
    <div id="overheadCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    <div class="cost-card">
    <div>Profit</div>
    <div id="profitCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    <div class="cost-card" style="border-top-color: var(--success);">
    <div>Total Cost</div>
    <div id="totalCost" class="cost-value">-</div>
    <div class="currency-unit">PHP</div>
    </div>
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Project Summary</span>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label>Total Boxes</label>
    <input type="text" id="totalBoxes" readonly style="background-color: #f8f9fa;">
    </div>
    <div class="input-group">
    <label>Total Labor Hours</label>
    <input type="text" id="totalLaborHours" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    <div class="input-group">
    <label>Project Duration (Standard Crew)</label>
    <input type="text" id="projectDuration" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Procurement Summary</span>
    </div>
    <table class="bill-of-quantity-table" id="procurementTable">
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="4" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    </table>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>NEC Compliance Summary</span>
    </div>
    <div id="necComplianceSummary">
    <p>NEC compliance details will appear here after calculation.</p>
    </div>
    </div>
    </div>
    </div>
    </main>
    </div>
    <script>
    // Global variables
    let projectData = {};
    let lastNecResult = null;

    // Standard Box Capacities (cubic inches)
    const BOX_CAPACITIES = {
        'Utility Box (Standard)': 18.0,
        'Utility Box (Deep)': 22.5,
        '4x4 Junction Box (1.5")': 21.0,
        '4x4 Junction Box (2.125")': 30.3,
        '4x4 Square Box (1.5")': 21.0,
        '4x4 Square Box (2.125")': 30.3,
        'Two Gang Box (Standard)': 30.0,
        'Two Gang Box (Deep)': 42.0
    };

    // Set default date to today
    document.getElementById('projectDate').valueAsDate = new Date();
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-content').forEach(c => {
    c.classList.remove('active');
    });
    
    // Activate clicked tab
    this.classList.add('active');
    this.setAttribute('aria-selected', 'true');
    const tabId = this.getAttribute('data-tab') + '-tab';
    document.getElementById(tabId).classList.add('active');
    });
    
    // Keyboard navigation for tabs
    tab.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    this.click();
    }
    });
    });
    
    // Utility functions
    function safeNumber(v, fallback = 0) {
    if (v === "" || v === null || v === undefined) return fallback;
    const n = Number(v);
    return isNaN(n) ? fallback : n;
    }

    function formatNumber(num, dp = 2) {
    if (typeof num !== 'number' || isNaN(num)) return "0.00";
    const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
    return rounded.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
    }

    function formatCurrency(n) {
    if (typeof n !== 'number' || isNaN(n)) return "PHP 0.00";
    const c = document.getElementById('currency').value;
    let symbol = "";
    switch (c) {
    case 'PHP': symbol = 'PHP'; break;
    case 'USD': symbol = '$'; break;
    case 'EUR': symbol = '€'; break;
    case 'JPY': symbol = '¥'; break;
    default: symbol = c + '';
    }
    return symbol + ' ' + formatNumber(n, 2);
    }
    
    // Distribution validation
    function validateDistribution() {
    const pctJunc = safeNumber(document.getElementById('pctJunc').value);
    const pctUtil = safeNumber(document.getElementById('pctUtil').value);
    const pctSq = safeNumber(document.getElementById('pctSq').value);
    const pctPull = safeNumber(document.getElementById('pctPull').value);
    const pctGutter = safeNumber(document.getElementById('pctGutter').value);
    const pctWire4 = safeNumber(document.getElementById('pctWire4').value);
    const pctWire6 = safeNumber(document.getElementById('pctWire6').value);
    const pctWire8 = safeNumber(document.getElementById('pctWire8').value);
    
    const total = pctJunc + pctUtil + pctSq + pctPull + pctGutter + pctWire4 + pctWire6 + pctWire8;
    document.getElementById('distributionTotal').value = total.toFixed(1) + '%';
    
    const errorElement = document.getElementById('distributionError');
    if (Math.abs(total - 100) > 0.1) {
    errorElement.textContent = 'Distribution percentages must add up to 100% (Current: ' + total.toFixed(1) + '%)';
    errorElement.style.display = 'block';
    return false;
    } else {
    errorElement.style.display = 'none';
    return true;
    }
    }
    
    // Add distribution validation to percentage inputs
    const percentageInputs = ['pctJunc', 'pctUtil', 'pctSq', 'pctPull', 'pctGutter', 'pctWire4', 'pctWire6', 'pctWire8'];
    percentageInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', validateDistribution);
    });
    
    // CORRECTED NEC Box Fill Calculation
    function calculateNECBoxFill() {
    const conductorSize = parseInt(document.getElementById('conductorSize').value, 10);
    const currentConductors = safeNumber(document.getElementById('currentConductors').value);
    const groundingConductors = safeNumber(document.getElementById('groundingConductors').value);
    const devicesCount = safeNumber(document.getElementById('devicesCount').value);
    const cableClamps = safeNumber(document.getElementById('cableClamps').value);
    // include pigtails
    const pigtails = document.getElementById('pigtails') ? safeNumber(document.getElementById('pigtails').value) : 0;
    const boxVolume = safeNumber(document.getElementById('boxVolume').value);
    const safetyFactor = (document.getElementById('safetyFactor') ? safeNumber(document.getElementById('safetyFactor').value) / 100 : 0);

    const conductorVolumes = { 18:1.5, 16:1.75, 14:2.0, 12:2.25, 10:2.5, 8:3.0, 6:5.0 };
    const volPerConductor = conductorVolumes[conductorSize] || conductorVolumes[12];

    // NEC counting:
    // - current-carrying conductors: count each
    // - pigtails: count each (they occupy box space)
    // - equipment grounds: ALL grounding conductors together count AS ONE conductor equivalent
    // - devices (yokes): count as 2 conductors per yoke
    // - internal clamps: count as 1 conductor equivalent each
    const currentVolume = (currentConductors + pigtails) * volPerConductor;
    const groundVolume = (groundingConductors > 0 ? volPerConductor : 0); // counts as ONE equivalent if any
    const deviceVolume = devicesCount * 2 * volPerConductor;
    const clampVolume = cableClamps * volPerConductor;

    const totalVolumeRequired = currentVolume + groundVolume + deviceVolume + clampVolume;
    const volumeWithSafety = totalVolumeRequired * (1 + safetyFactor);

    // Build detailed result object for UI + PDF audit
    const necResult = {
    conductorSize,
    currentConductors,
    pigtails,
    groundingConductors,
    devicesCount,
    cableClamps,
    volPerConductor,
    currentVolume,
    groundVolume,
    deviceVolume,
    clampVolume,
    totalVolumeRequired,
    volumeWithSafety,
    boxVolume,
    safetyFactor: safetyFactor * 100
    };

    // Render UI details
    const detailsElement = document.getElementById('necDetails');
    let detailsHTML = '<p><strong>Calculation Details:</strong></p><ul>';
    detailsHTML += `<li>Current conductors: ${currentConductors} + pigtails ${pigtails} = ${(currentConductors + pigtails)} × ${volPerConductor} cu. in. = ${formatNumber(currentVolume,2)} cu. in.</li>`;
    detailsHTML += `<li>Equipment grounds: ${groundingConductors} (counted as one) = ${formatNumber(groundVolume,2)} cu. in.</li>`;
    detailsHTML += `<li>Devices (yokes): ${devicesCount} × 2 × ${volPerConductor} = ${formatNumber(deviceVolume,2)} cu. in.</li>`;
    detailsHTML += `<li>Internal clamps: ${cableClamps} × ${volPerConductor} = ${formatNumber(clampVolume,2)} cu. in.</li>`;
    detailsHTML += `</ul><p>Total Required: ${formatNumber(totalVolumeRequired,2)} cu. in.</p>`;
    detailsHTML += `<p>With safety factor: ${formatNumber(volumeWithSafety,2)} cu. in.</p>`;
    detailsHTML += `<p>Box Volume Available: ${formatNumber(boxVolume,2)} cu. in.</p>`;
    detailsElement.innerHTML = detailsHTML;

    const resultElement = document.getElementById('necResult');
    if (boxVolume <= 0) {
    resultElement.textContent = 'Please enter a valid box volume';
    resultElement.className = 'nec-result nec-warning';
    } else if (volumeWithSafety <= boxVolume) {
    resultElement.textContent = `PASS: ${formatNumber(volumeWithSafety,2)} cu. in. required (including safety) ≤ ${formatNumber(boxVolume,2)} cu. in. available`;
    resultElement.className = 'nec-result nec-pass';
    } else {
    resultElement.textContent = `FAIL: ${formatNumber(volumeWithSafety,2)} cu. in. required (including safety) > ${formatNumber(boxVolume,2)} cu. in. available`;
    resultElement.className = 'nec-result nec-fail';
    }

    // store for export
    lastNecResult = necResult;
    return necResult;
    }
    
    // Add event listeners for NEC calculation
    document.getElementById('conductorSize').addEventListener('change', calculateNECBoxFill);
    document.getElementById('currentConductors').addEventListener('input', calculateNECBoxFill);
    document.getElementById('groundingConductors').addEventListener('input', calculateNECBoxFill);
    document.getElementById('devicesCount').addEventListener('input', calculateNECBoxFill);
    document.getElementById('cableClamps').addEventListener('input', calculateNECBoxFill);
    document.getElementById('pigtails').addEventListener('input', calculateNECBoxFill);
    document.getElementById('boxVolume').addEventListener('input', calculateNECBoxFill);
    document.getElementById('safetyFactor').addEventListener('input', calculateNECBoxFill);
    
    // Initial NEC calculation
    calculateNECBoxFill();
    
    // Main calculation function
    function calculateEstimate() {
    // Validate inputs first
    if (!validateInputs()) {
    return;
    }

    // Get input values
    const wallArea = parseFloat(document.getElementById('wallArea').value);
    const density = parseFloat(document.getElementById('density').value);
    const wastage = parseFloat(document.getElementById('wastage').value) / 100;
    const overheadRate = parseFloat(document.getElementById('overheadRate').value) / 100;
    const profitMarginRate = parseFloat(document.getElementById('profitMarginRate').value) / 100;
    const laborRate = parseFloat(document.getElementById('laborRate').value);
    const productivity = parseFloat(document.getElementById('productivity').value);
    const crewSize = parseFloat(document.getElementById('crewSize').value);
    const workHours = parseFloat(document.getElementById('workHours').value);
    
    // Calculate total outlets
    const totalOutlets = wallArea * density;
    
    // Get box distribution percentages
    const pctJunc = parseFloat(document.getElementById('pctJunc').value) / 100;
    const pctUtil = parseFloat(document.getElementById('pctUtil').value) / 100;
    const pctSq = parseFloat(document.getElementById('pctSq').value) / 100;
    const pctPull = parseFloat(document.getElementById('pctPull').value) / 100;
    const pctGutter = parseFloat(document.getElementById('pctGutter').value) / 100;
    const pctWire4 = parseFloat(document.getElementById('pctWire4').value) / 100;
    const pctWire6 = parseFloat(document.getElementById('pctWire6').value) / 100;
    const pctWire8 = parseFloat(document.getElementById('pctWire8').value) / 100;
    
    // Get unit costs
    const costJunc = parseFloat(document.getElementById('costJunc').value);
    const costUtil = parseFloat(document.getElementById('costUtil').value);
    const costSq = parseFloat(document.getElementById('costSq').value);
    const costPull = parseFloat(document.getElementById('costPull').value);
    const costGutter = parseFloat(document.getElementById('costGutter').value);
    const costNip = parseFloat(document.getElementById('costNip').value);
    const costWire4 = parseFloat(document.getElementById('costWire4').value);
    const costWire6 = parseFloat(document.getElementById('costWire6').value);
    const costWire8 = parseFloat(document.getElementById('costWire8').value);
    const costCover = parseFloat(document.getElementById('costCover').value);
    
    // Calculate quantities for each box type
    const qtyJunc = Math.ceil(totalOutlets * pctJunc);
    const qtyUtil = Math.ceil(totalOutlets * pctUtil);
    const qtySq = Math.ceil(totalOutlets * pctSq);
    const qtyPull = Math.ceil(totalOutlets * pctPull);
    const qtyGutter = Math.ceil(totalOutlets * pctGutter);
    const qtyWire4 = Math.ceil(totalOutlets * pctWire4);
    const qtyWire6 = Math.ceil(totalOutlets * pctWire6);
    const qtyWire8 = Math.ceil(totalOutlets * pctWire8);
    const qtyNip = Math.ceil(totalOutlets * 0.8); // Assume 80% of boxes need nipples
    const qtyCover = Math.ceil(totalOutlets); // One cover per box
    
    // Calculate material costs with wastage
    const materialCostJunc = qtyJunc * costJunc * (1 + wastage);
    const materialCostUtil = qtyUtil * costUtil * (1 + wastage);
    const materialCostSq = qtySq * costSq * (1 + wastage);
    const materialCostPull = qtyPull * costPull * (1 + wastage);
    const materialCostGutter = qtyGutter * costGutter * (1 + wastage);
    const materialCostNip = qtyNip * costNip * (1 + wastage);
    const materialCostWire4 = qtyWire4 * costWire4 * (1 + wastage);
    const materialCostWire6 = qtyWire6 * costWire6 * (1 + wastage);
    const materialCostWire8 = qtyWire8 * costWire8 * (1 + wastage);
    const materialCostCover = qtyCover * costCover * (1 + wastage);
    
    // Calculate total material cost
    const totalMaterialCost = materialCostJunc + materialCostUtil + materialCostSq + materialCostPull + 
    materialCostGutter + materialCostNip + materialCostWire4 + materialCostWire6 + 
    materialCostWire8 + materialCostCover;
    
    // Calculate labor cost
    const totalLaborHours = totalOutlets / (productivity * crewSize);
    const totalLaborCost = totalLaborHours * laborRate * crewSize;
    
    // Calculate direct cost
    const directCost = totalMaterialCost + totalLaborCost;
    
    // Calculate overhead and profit
    const overheadCost = directCost * overheadRate;
    const profitCost = (directCost + overheadCost) * profitMarginRate;
    
    // Calculate total cost
    const totalCost = directCost + overheadCost + profitCost;
    
    // Update Bill of Quantities table
    const boqTable = document.getElementById('billOfQuantity');
    const currencySymbol = getCurrencySymbol();
    
    boqTable.innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Junction Box</td>
    <td>4x4" Junction Box</td>
    <td>${qtyJunc}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costJunc, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostJunc, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyJunc / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Utility Box</td>
    <td>Standard Utility Box</td>
    <td>${qtyUtil}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costUtil, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostUtil, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyUtil / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Square Box</td>
    <td>4" Square Box</td>
    <td>${qtySq}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costSq, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostSq, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtySq / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Pull Box</td>
    <td>8x8" Pull Box</td>
    <td>${qtyPull}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costPull, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostPull, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyPull / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Gutter</td>
    <td>Wire Gutter</td>
    <td>${qtyGutter}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costGutter, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostGutter, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyGutter / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Closed Nipple</td>
    <td>1/2" Closed Nipple</td>
    <td>${qtyNip}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costNip, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostNip, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyNip / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 4x4</td>
    <td>4x4" Wireway</td>
    <td>${qtyWire4}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire4, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire4, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire4 / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 6x6</td>
    <td>6x6" Wireway</td>
    <td>${qtyWire6}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire6, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire6, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire6 / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 8x8</td>
    <td>8x8" Wireway</td>
    <td>${qtyWire8}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire8, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire8, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire8 / productivity * laborRate, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Covers</td>
    <td>Blank Covers</td>
    <td>${qtyCover}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costCover, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostCover, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyCover / productivity * laborRate, currencySymbol)}</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td class="text-right">${formatCurrency(totalMaterialCost, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(totalLaborCost, currencySymbol)}</td>
    </tr>
    </tfoot>
    `;
    
    // Update cost breakdown
    document.getElementById('materialCost').textContent = formatCurrency(totalMaterialCost, currencySymbol);
    document.getElementById('laborCost').textContent = formatCurrency(totalLaborCost, currencySymbol);
    document.getElementById('directCost').textContent = formatCurrency(directCost, currencySymbol);
    document.getElementById('overheadCost').textContent = formatCurrency(overheadCost, currencySymbol);
    document.getElementById('profitCost').textContent = formatCurrency(profitCost, currencySymbol);
    document.getElementById('totalCost').textContent = formatCurrency(totalCost, currencySymbol);
    
    // Update project summary
    document.getElementById('totalBoxes').value = Math.round(totalOutlets) + ' boxes';
    document.getElementById('totalLaborHours').value = totalLaborHours.toFixed(1) + ' hours';
    document.getElementById('projectDuration').value = (totalLaborHours / workHours).toFixed(1) + ' days';
    
    // Update procurement table
    const procurementTable = document.getElementById('procurementTable');
    procurementTable.innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Junction Box</td>
    <td>${qtyJunc}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtyJunc / 10)}</td>
    </tr>
    <tr>
    <td>Utility Box</td>
    <td>${qtyUtil}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtyUtil / 10)}</td>
    </tr>
    <tr>
    <td>Square Box</td>
    <td>${qtySq}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtySq / 10)}</td>
    </tr>
    <tr>
    <td>Pull Box</td>
    <td>${qtyPull}</td>
    <td>Individual</td>
    <td>${qtyPull}</td>
    </tr>
    <tr>
    <td>Gutter</td>
    <td>${qtyGutter}</td>
    <td>Individual</td>
    <td>${qtyGutter}</td>
    </tr>
    <tr>
    <td>Closed Nipple</td>
    <td>${qtyNip}</td>
    <td>Box of 100</td>
    <td>${Math.ceil(qtyNip / 100)}</td>
    </tr>
    <tr>
    <td>Wireway 4x4</td>
    <td>${qtyWire4}</td>
    <td>Individual</td>
    <td>${qtyWire4}</td>
    </tr>
    <tr>
    <td>Wireway 6x6</td>
    <td>${qtyWire6}</td>
    <td>Individual</td>
    <td>${qtyWire6}</td>
    </tr>
    <tr>
    <td>Wireway 8x8</td>
    <td>${qtyWire8}</td>
    <td>Individual</td>
    <td>${qtyWire8}</td>
    </tr>
    <tr>
    <td>Covers</td>
    <td>${qtyCover}</td>
    <td>Carton of 25</td>
    <td>${Math.ceil(qtyCover / 25)}</td>
    </tr>
    </tbody>
    `;

    // Check NEC compliance for box types
    checkNECCompliance();
    
    // Update currency units
    document.querySelectorAll('.currency-unit').forEach(el => {
    el.textContent = currencySymbol;
    });

    // Store project data for export
    projectData = {
    projectName: document.getElementById('projectName').value,
    bidNumber: document.getElementById('bidNumber').value,
    clientName: document.getElementById('clientName').value,
    projectLocation: document.getElementById('projectLocation').value,
    preparedBy: document.getElementById('preparedBy').value,
    projectDate: document.getElementById('projectDate').value,
    currency: document.getElementById('currency').value,
    totals: {
        totalMaterialCost,
        totalLaborCost,
        directCost,
        overheadCost,
        profitCost,
        totalCost
    },
    quantities: {
        totalOutlets,
        qtyJunc,
        qtyUtil,
        qtySq,
        qtyPull,
        qtyGutter,
        qtyWire4,
        qtyWire6,
        qtyWire8,
        qtyNip,
        qtyCover
    },
    labor: {
        totalLaborHours,
        productivity,
        crewSize,
        laborRate,
        workHours
    },
    nec: lastNecResult
    };
    }
    
    // Check NEC compliance for box types
    function checkNECCompliance() {
    if (!lastNecResult) return;
    
    const requiredVolume = lastNecResult.volumeWithSafety;
    const summaryElement = document.getElementById('necComplianceSummary');
    const warningElement = document.getElementById('necComplianceWarning');
    
    let summaryHTML = '<p><strong>NEC 314.16 Compliance Check:</strong></p>';
    summaryHTML += `<p>Required Volume (with safety): ${formatNumber(requiredVolume, 2)} cu. in.</p>`;
    summaryHTML += '<p><strong>Suitable Box Types:</strong></p><ul>';
    
    let hasComplianceIssue = false;
    let suitableBoxes = [];
    
    // Check each standard box type
    Object.entries(BOX_CAPACITIES).forEach(([boxName, capacity]) => {
    if (capacity >= requiredVolume) {
        suitableBoxes.push({ name: boxName, capacity });
        summaryHTML += `<li>${boxName}: ${capacity} cu. in. (${formatNumber(capacity - requiredVolume, 2)} cu. in. spare)</li>`;
    }
    });
    
    if (suitableBoxes.length === 0) {
    summaryHTML += '<li>No standard boxes meet the requirement. Consider custom or oversized boxes.</li>';
    hasComplianceIssue = true;
    }
    
    summaryHTML += '</ul>';
    
    // Check if utility boxes (most common) would be sufficient
    const utilityBoxCapacity = BOX_CAPACITIES['Utility Box (Standard)'];
    const utilityBoxPercentage = parseFloat(document.getElementById('pctUtil').value) || 0;
    
    if (utilityBoxPercentage > 0 && requiredVolume > utilityBoxCapacity) {
    summaryHTML += `<div class="nec-warning" style="padding: 10px; margin-top: 10px;">
        <strong>Warning:</strong> Your distribution includes ${utilityBoxPercentage}% utility boxes, 
        but standard utility boxes (${utilityBoxCapacity} cu. in.) may be insufficient. 
        Consider using deep utility boxes (${BOX_CAPACITIES['Utility Box (Deep)']} cu. in.) 
        or adjusting your distribution.
    </div>`;
    hasComplianceIssue = true;
    }
    
    summaryElement.innerHTML = summaryHTML;
    
    if (hasComplianceIssue) {
    warningElement.classList.remove('hidden');
    } else {
    warningElement.classList.add('hidden');
    }
    }
    
    // Input validation function
    function validateInputs() {
    let isValid = true;
    
    // Project name validation
    const projectName = document.getElementById('projectName').value.trim();
    if (!projectName) {
    document.getElementById('projectNameError').style.display = 'block';
    document.getElementById('projectName').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('projectNameError').style.display = 'none';
    document.getElementById('projectName').classList.remove('input-error');
    }
    
    // Wall area validation
    const wallArea = parseFloat(document.getElementById('wallArea').value);
    if (isNaN(wallArea) || wallArea <= 0) {
    document.getElementById('wallAreaError').style.display = 'block';
    document.getElementById('wallArea').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('wallAreaError').style.display = 'none';
    document.getElementById('wallArea').classList.remove('input-error');
    }
    
    // Density validation
    const density = parseFloat(document.getElementById('density').value);
    if (isNaN(density) || density < 0) {
    document.getElementById('densityError').style.display = 'block';
    document.getElementById('density').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('densityError').style.display = 'none';
    document.getElementById('density').classList.remove('input-error');
    }
    
    // Wastage validation
    const wastage = parseFloat(document.getElementById('wastage').value);
    if (isNaN(wastage) || wastage < 0 || wastage > 30) {
    document.getElementById('wastageError').style.display = 'block';
    document.getElementById('wastage').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('wastageError').style.display = 'none';
    document.getElementById('wastage').classList.remove('input-error');
    }
    
    // Overhead rate validation
    const overheadRate = parseFloat(document.getElementById('overheadRate').value);
    if (isNaN(overheadRate) || overheadRate < 0 || overheadRate > 100) {
    document.getElementById('overheadRateError').style.display = 'block';
    document.getElementById('overheadRate').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('overheadRateError').style.display = 'none';
    document.getElementById('overheadRate').classList.remove('input-error');
    }
    
    // Profit margin validation
    const profitMargin = parseFloat(document.getElementById('profitMarginRate').value);
    if (isNaN(profitMargin) || profitMargin < 0 || profitMargin > 100) {
    document.getElementById('profitMarginError').style.display = 'block';
    document.getElementById('profitMarginRate').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('profitMarginError').style.display = 'none';
    document.getElementById('profitMarginRate').classList.remove('input-error');
    }
    
    // Distribution validation
    if (!validateDistribution()) {
    isValid = false;
    }
    
    return isValid;
    }
    
    // Currency formatting functions
    function getCurrencySymbol() {
    const currency = document.getElementById('currency').value;
    switch (currency) {
    case 'USD': return '$';
    case 'EUR': return '€';
    case 'JPY': return '¥';
    default: return 'PHP';
    }
    }
    
    // Export to PDF
    function exportToPDF() {
    if (!projectData.totals) {
    alert('No results to export. Please calculate an estimate first.');
    return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(16);
    doc.text('Professional Electrical Boxes & Covers Estimate', 20, 20);
    
    // Add project details
    doc.setFontSize(12);
    doc.text('Project: ' + projectData.projectName, 20, 40);
    doc.text('Client: ' + projectData.clientName, 20, 50);
    doc.text('Prepared By: ' + projectData.preparedBy, 20, 60);
    doc.text('Date: ' + projectData.projectDate, 20, 70);
    doc.text('Bid Number: ' + projectData.bidNumber, 20, 80);
    
    // Add cost summary
    doc.text('Cost Summary:', 20, 100);
    doc.text('Material Cost: ' + formatCurrency(projectData.totals.totalMaterialCost), 30, 110);
    doc.text('Labor Cost: ' + formatCurrency(projectData.totals.totalLaborCost), 30, 120);
    doc.text('Direct Cost: ' + formatCurrency(projectData.totals.directCost), 30, 130);
    doc.text('Overhead: ' + formatCurrency(projectData.totals.overheadCost), 30, 140);
    doc.text('Profit: ' + formatCurrency(projectData.totals.profitCost), 30, 150);
    doc.text('Total Cost: ' + formatCurrency(projectData.totals.totalCost), 30, 160);
    
    // Add project summary
    doc.text('Project Summary:', 20, 180);
    doc.text('Total Boxes: ' + Math.round(projectData.quantities.totalOutlets), 30, 190);
    doc.text('Total Labor Hours: ' + projectData.labor.totalLaborHours.toFixed(1), 30, 200);
    doc.text('Project Duration: ' + (projectData.labor.totalLaborHours / projectData.labor.workHours).toFixed(1) + ' days', 30, 210);
    
    // Add NEC compliance details if available
    if (lastNecResult) {
    doc.text('NEC Compliance Details:', 20, 230);
    doc.text('Required Volume: ' + formatNumber(lastNecResult.volumeWithSafety, 2) + ' cu. in.', 30, 240);
    doc.text('Conductor Size: ' + lastNecResult.conductorSize + ' AWG', 30, 250);
    doc.text('Safety Factor: ' + lastNecResult.safetyFactor + '%', 30, 260);
    
    // Add detailed NEC calculation
    let yPos = 280;
    doc.text('NEC Calculation Breakdown:', 20, yPos);
    yPos += 10;
    doc.text('Current Conductors: ' + lastNecResult.currentConductors + ' + Pigtails: ' + lastNecResult.pigtails, 30, yPos);
    yPos += 10;
    doc.text('Grounding Conductors: ' + lastNecResult.groundingConductors + ' (counted as one)', 30, yPos);
    yPos += 10;
    doc.text('Devices: ' + lastNecResult.devicesCount + ' × 2 volume allowance', 30, yPos);
    yPos += 10;
    doc.text('Cable Clamps: ' + lastNecResult.cableClamps, 30, yPos);
    yPos += 10;
    doc.text('Volume per Conductor: ' + formatNumber(lastNecResult.volPerConductor, 2) + ' cu. in.', 30, yPos);
    }
    
    // Add labor calculation details
    let laborYPos = yPos + 20;
    doc.text('Labor Calculation Details:', 20, laborYPos);
    laborYPos += 10;
    doc.text('Productivity: ' + projectData.labor.productivity + ' boxes/hour per worker', 30, laborYPos);
    laborYPos += 10;
    doc.text('Crew Size: ' + projectData.labor.crewSize + ' workers', 30, laborYPos);
    laborYPos += 10;
    doc.text('Labor Rate: ' + formatCurrency(projectData.labor.laborRate) + '/hour', 30, laborYPos);
    laborYPos += 10;
    doc.text('Work Hours: ' + projectData.labor.workHours + ' hours/day', 30, laborYPos);
    
    // Save the PDF
    doc.save('Electrical_Estimate_' + projectData.projectName.replace(/\s+/g, '_') + '.pdf');
    }
    
    // Export to Excel
    function exportToExcel() {
    if (!projectData.totals) {
    alert('No results to export. Please calculate an estimate first.');
    return;
    }
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Prepare data for the Bill of Quantities sheet
    const boqData = [
    ['Item', 'Description', 'Qty', 'Unit', 'Unit Cost', 'Material Cost', 'Labor Cost']
    ];
    
    // Get data from the table
    const boqTable = document.getElementById('billOfQuantity');
    const rows = boqTable.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length > 1) { // Skip empty rows
    const rowData = [];
    cells.forEach(cell => {
    rowData.push(cell.textContent);
    });
    boqData.push(rowData);
    }
    });
    
    // Add total row
    const totalRow = boqTable.querySelector('tfoot tr');
    const totalCells = totalRow.querySelectorAll('td');
    const totalData = [];
    totalCells.forEach(cell => {
    totalData.push(cell.textContent);
    });
    boqData.push(totalData);
    
    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(boqData);
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Bill of Quantities');
    
    // Create NEC compliance sheet
    const necData = [
    ['NEC 314.16 Compliance Details'],
    ['Conductor Size', lastNecResult ? lastNecResult.conductorSize + ' AWG' : ''],
    ['Current Conductors', lastNecResult ? lastNecResult.currentConductors : ''],
    ['Pigtails', lastNecResult ? lastNecResult.pigtails : ''],
    ['Grounding Conductors', lastNecResult ? lastNecResult.groundingConductors : ''],
    ['Devices', lastNecResult ? lastNecResult.devicesCount : ''],
    ['Cable Clamps', lastNecResult ? lastNecResult.cableClamps : ''],
    ['Volume per Conductor', lastNecResult ? formatNumber(lastNecResult.volPerConductor, 2) + ' cu. in.' : ''],
    ['Total Volume Required', lastNecResult ? formatNumber(lastNecResult.totalVolumeRequired, 2) + ' cu. in.' : ''],
    ['Safety Factor', lastNecResult ? lastNecResult.safetyFactor + '%' : ''],
    ['Volume with Safety', lastNecResult ? formatNumber(lastNecResult.volumeWithSafety, 2) + ' cu. in.' : ''],
    ['Box Volume Available', lastNecResult ? formatNumber(lastNecResult.boxVolume, 2) + ' cu. in.' : '']
    ];
    
    const necWs = XLSX.utils.aoa_to_sheet(necData);
    XLSX.utils.book_append_sheet(wb, necWs, 'NEC Compliance');
    
    // Save the workbook
    XLSX.writeFile(wb, 'Electrical_Estimate_' + projectData.projectName.replace(/\s+/g, '_') + '.xlsx');
    }
    
    // Reset function
    function resetCalculator() {
    if (confirm('Are you sure you want to reset all inputs? This action cannot be undone.')) {
    // Reset form inputs to default values
    document.getElementById('projectName').value = 'Commercial Fit-Out Project';
    document.getElementById('bidNumber').value = 'BID-2024-001';
    document.getElementById('clientName').value = 'ABC Development Corporation';
    document.getElementById('projectLocation').value = 'Makati City, Philippines';
    document.getElementById('preparedBy').value = 'John Smith, Licensed Electrical Engineer';
    document.getElementById('projectDate').valueAsDate = new Date();
    
    document.getElementById('wallArea').value = '250';
    document.getElementById('density').value = '0.6';
    document.getElementById('wastage').value = '10';
    document.getElementById('overheadRate').value = '18';
    document.getElementById('profitMarginRate').value = '22';
    
    // Reset results
    document.getElementById('billOfQuantity').innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="7" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td id="totalMaterialCost" class="text-right">-</td>
    <td id="totalLaborCost" class="text-right">-</td>
    </tr>
    </tfoot>
    `;
    
    document.getElementById('procurementTable').innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="4" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    `;
    
    // Reset cost breakdown
    document.getElementById('materialCost').textContent = '-';
    document.getElementById('laborCost').textContent = '-';
    document.getElementById('directCost').textContent = '-';
    document.getElementById('overheadCost').textContent = '-';
    document.getElementById('profitCost').textContent = '-';
    document.getElementById('totalCost').textContent = '-';
    
    // Reset project summary
    document.getElementById('totalBoxes').value = '';
    document.getElementById('totalLaborHours').value = '';
    document.getElementById('projectDuration').value = '';
    
    // Reset NEC compliance
    document.getElementById('necComplianceSummary').innerHTML = '<p>NEC compliance details will appear here after calculation.</p>';
    document.getElementById('necComplianceWarning').classList.add('hidden');
    
    // Clear validation errors
    document.querySelectorAll('.error-message').forEach(el => {
    el.style.display = 'none';
    });
    document.querySelectorAll('.input-error').forEach(el => {
    el.classList.remove('input-error');
    });
    
    // Reset project data
    projectData = {};
    lastNecResult = null;
    }
    }
    
    // Event listeners
    document.getElementById('calculateBtn').addEventListener('click', calculateEstimate);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
    document.getElementById('resetBtn').addEventListener('click', resetCalculator);
    
    // Currency change handler
    document.getElementById('currency').addEventListener('change', function() {
    // Update currency display in results if they exist
    if (document.getElementById('materialCost').textContent !== '-') {
    calculateEstimate();
    }
    });
    
    // Initial distribution validation
    validateDistribution();
    </script>
    </body>
    </html>
