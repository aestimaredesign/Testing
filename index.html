<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Power Distribution Systems Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#f8f9fa; color:#333; line-height:1.6;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    header { background:var(--primary); color:#fff; padding:1rem 0; margin-bottom:2rem; border-radius:8px; }
    .header-content { display:flex; justify-content:space-between; align-items:center; padding:0 20px; }
    h1 { font-size:2rem; font-weight:600; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-weight:500; transition:all 0.3s ease; }
    .btn-primary { background:var(--secondary); color:#fff; }
    .btn-success { background:var(--success); color:#fff; }
    .btn-warning { background:var(--warning); color:#fff; }
    .btn-danger { background:var(--danger); color:#fff; }
    .btn:hover { opacity:0.9; transform:translateY(-1px); }
    .calculator-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:2rem; }
    @media(max-width:1024px){ .calculator-grid { grid-template-columns:1fr; } }
    .input-section,.output-section { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .section-title { font-size:1.5rem; font-weight:600; margin-bottom:1rem; border-bottom:2px solid var(--light); padding-bottom:.5rem; color:var(--primary); }
    .input-group { margin-bottom:1rem; }
    .input-row,.financial-input-row { display:grid; gap:10px; margin-bottom:10px; align-items:end; }
    .input-row { grid-template-columns:1fr 1fr 1fr; }
    .financial-input-row { grid-template-columns:1fr 1fr; }
    label { display:block; margin-bottom:5px; font-weight:500; color:var(--dark); }
    input,select { width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
    input:focus,select:focus { outline:none; border-color:var(--secondary); box-shadow:0 0 0 2px rgba(52,152,219,0.2); }
    .unit-toggle,.standard-toggle { display:flex; gap:10px; margin-bottom:1rem; }
    .unit-btn,.standard-btn { flex:1; padding:10px; text-align:center; background:var(--light); border:1px solid #ddd; border-radius:4px; cursor:pointer; }
    .unit-btn.active { background:var(--secondary); color:#fff; border-color:var(--secondary); }
    .standard-btn.active { background:var(--success); color:#fff; border-color:var(--success); }
    .work-item { background:var(--light); padding:15px; border-radius:6px; margin-bottom:15px; border-left:4px solid var(--secondary); }
    .work-item-title { font-weight:600; margin-bottom:10px; color:var(--primary); }
    .bill-of-quantity-table { width:100%; border-collapse:collapse; margin-top:1rem; }
    .bill-of-quantity-table th,.bill-of-quantity-table td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
    .bill-of-quantity-table th { background:var(--primary); color:#fff; font-weight:600; }
    .bill-of-quantity-table tr:hover { background:#f5f5f5; }
    .total-row { font-weight:600; background:var(--light)!important; }
    .tab-container { margin-bottom:1rem; }
    .tabs { display:flex; border-bottom:1px solid #ddd; margin-bottom:1rem; flex-wrap:wrap; }
    .tab { padding:10px 20px; cursor:pointer; border-bottom:3px solid transparent; }
    .tab.active { border-bottom-color:var(--secondary); color:var(--secondary); font-weight:600; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <h1>Power Distribution Systems Calculator</h1>
      <div class="controls">
        <button class="btn btn-primary" id="saveBtn">Save Project</button>
        <button class="btn btn-warning" id="loadBtn">Load Project</button>
        <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
        <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
        <button class="btn btn-danger" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <div class="calculator-grid">
    <!-- Input Section -->
    <div class="input-section">
      <h2 class="section-title">Project Inputs</h2>
      <div class="input-group">
        <label>Project Name</label>
        <input type="text" id="projectName" placeholder="Enter project name"/>
      </div>
      <div class="input-group">
        <label>Unit System</label>
        <div class="unit-toggle">
          <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
          <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
        </div>
      </div>
      <div class="input-group">
        <label>Electrical Standards</label>
        <div class="standard-toggle">
          <div class="standard-btn active" data-standard="philippine">Philippine (PEC)</div>
          <div class="standard-btn" data-standard="international">International (IEC)</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="general">General Parameters</div>
          <div class="tab" data-tab="distribution">Distribution Systems</div>
          <div class="tab" data-tab="cables">Cables & Wiring</div>
          <div class="tab" data-tab="costs">Additional Costs</div>
          <div class="tab" data-tab="help">Help & Reference</div>
        </div>

        <!-- General -->
        <div class="tab-content active" id="general-tab">
          <div class="input-row">
            <div class="input-group">
              <label>Labor Rate (per hour)</label>
              <input type="number" id="laborRate" value="250"/>
              <div class="unit-label">PHP/hour</div>
            </div>
            <div class="input-group">
              <label>Overhead Rate (%)</label>
              <input type="number" id="overheadRate" value="15"/>
            </div>
            <div class="input-group">
              <label>Profit Margin (%)</label>
              <input type="number" id="profitMarginRate" value="20"/>
            </div>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label>Currency</label>
              <select id="currency">
                <option value="PHP">Philippine Peso (‚Ç±)</option>
                <option value="USD">US Dollar ($)</option>
                <option value="EUR">Euro (‚Ç¨)</option>
                <option value="JPY">Japanese Yen (¬•)</option>
              </select>
            </div>
            <div class="input-group">
              <label>Project Location</label>
              <input type="text" id="projectLocation" placeholder="e.g. Manila, Philippines"/>
            </div>
            <div class="input-group">
              <label>Project Date</label>
              <input type="date" id="projectDate"/>
            </div>
          </div>
        </div>

        <!-- Distribution -->
        <div class="tab-content" id="distribution-tab">
          <p>üì¶ Distribution Systems inputs go here (MDBs, SMDBs, Panels, Breakers...)</p>
        </div>

        <!-- Cables -->
        <div class="tab-content" id="cables-tab">
          <p>üîå Cables & Wiring inputs go here (Power Cables, Trays, Bus Ducts...)</p>
        </div>

        <!-- Additional Costs -->
        <div class="tab-content" id="costs-tab">
          <p>üí∞ Additional cost inputs (Permits, Tools, Contingency...)</p>
        </div>

        <!-- Help -->
        <div class="tab-content" id="help-tab">
          <p>‚ÑπÔ∏è Reference, instructions, and PEC/IEC standards info here.</p>
        </div>
      </div>

      <button class="btn btn-primary" id="calculateBtn" style="width:100%;padding:12px">Calculate</button>
    </div>

    <!-- Output Section -->
    <div class="output-section">
      <h2 class="section-title">Estimate Results</h2>
      <div id="resultsPlaceholder"><p>Enter details and click "Calculate"...</p></div>
      <div id="resultsContent" class="hidden">
        <h3>Project: <span id="resultProjectName"></span></h3>
        <p><strong>Location:</strong> <span id="resultProjectLocation"></span></p>
        <p><strong>Date:</strong> <span id="resultProjectDate"></span></p>
        <p><strong>Standard:</strong> <span id="resultStandard"></span></p>
        <h4>Bill of Quantity</h4>
        <table class="bill-of-quantity-table" id="billOfQuantityTable">
          <thead>
            <tr>
              <th>Item</th><th>Scope</th><th>Qty</th><th>Unit</th><th>Material</th><th>Labor</th><th>Total</th>
            </tr>
          </thead>
          <tbody id="billOfQuantityTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" class="hidden" accept=".json"/>

<script>
  // =====================
  // Globals
  // =====================
  let currentUnitSystem = 'metric';
  let currentStandard = 'philippine';
  let projectData = {};

  // =====================
  // Currency Formatter Fix
  // =====================
  function formatCurrency(n) {
    if (typeof n !== "number" || isNaN(n)) return "";
    const c = document.getElementById("currency").value;
    const symbols = { PHP: "‚Ç±", USD: "$", EUR: "‚Ç¨", JPY: "¬•" };
    return symbols[c] + " " + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // =====================
  // TAB SWITCHING FIX
  // =====================
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.getAttribute("data-tab")+"-tab").classList.add("active");
    });
  });

  // =====================
  // Simple Calculation
  // =====================
  document.getElementById("calculateBtn").addEventListener("click", () => {
    const projectName = document.getElementById("projectName").value || "Unnamed Project";
    const location = document.getElementById("projectLocation").value || "Not Specified";
    const date = document.getElementById("projectDate").value || new Date().toLocaleDateString();
    document.getElementById("resultProjectName").textContent = projectName;
    document.getElementById("resultProjectLocation").textContent = location;
    document.getElementById("resultProjectDate").textContent = date;
    document.getElementById("resultStandard").textContent = currentStandard === "philippine" ? "PEC" : "IEC";
    document.getElementById("resultsPlaceholder").classList.add("hidden");
    document.getElementById("resultsContent").classList.remove("hidden");
    document.getElementById("billOfQuantityTableBody").innerHTML =
      "<tr><td>1</td><td>Sample Item</td><td>10</td><td>pcs</td><td>"+formatCurrency(5000)+"</td><td>"+formatCurrency(2500)+"</td><td>"+formatCurrency(7500)+"</td></tr>";
  });
</script>
</body>
</html>
