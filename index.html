<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Pipes and Fittings Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .output-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .input-row-dynamic {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .unit-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .unit-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .unit-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .work-item {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }

        .work-item-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bill-of-quantity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .bill-of-quantity-table th,
        .bill-of-quantity-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .bill-of-quantity-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .bill-of-quantity-table tr:hover {
            background-color: #f5f5f5;
        }

        .total-row {
            font-weight: 600;
            background-color: var(--light) !important;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .cost-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid var(--secondary);
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }

        .tab-container {
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .unit-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .crew-sizing {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .crew-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .crew-option {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .bill-of-quantity-table td:nth-child(3),
        .bill-of-quantity-table td:nth-child(5),
        .bill-of-quantity-table td:nth-child(6),
        .bill-of-quantity-table td:nth-child(7) { text-align: right; }
        .bill-of-quantity-table td:nth-child(1),
        .bill-of-quantity-table td:nth-child(4) { text-align: center; }

        .hidden {
            display: none;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .remove-btn:hover {
            opacity: 0.9;
        }

        .input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2) !important;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 3px;
            display: none;
        }

        /* Help section backgrounds */
        .help-section {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .help-section h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }

        .how-to-use {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
        }

        .calculation-formulas {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
        }

        .standard-sizes {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
        }

        .step-guide p {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .step-number {
            display: inline-block;
            background: var(--secondary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .formula-box, .reference-box {
            padding: 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            margin-top: 10px;
        }

        .formula-box h4, .reference-box h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .formula-box p, .reference-box ul {
            margin-bottom: 8px;
        }

        .reference-box ul {
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Electrical Pipes and Fittings Calculator</h1>
                <div class="controls">
                    <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
                    <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
                    <button class="btn btn-danger" id="resetBtn">Reset</button>
                </div>
            </div>
        </header>

        <div class="calculator-grid">
            <div class="input-section">
                <h2 class="section-title">Project Inputs</h2>

                <div class="input-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                    <div class="error-message" id="projectNameError">Project name is required</div>
                </div>

                <div class="input-group">
                    <label>Client Name</label>
                    <input type="text" id="clientName" placeholder="Enter client name">
                </div>

                <div class="input-group">
                    <label>Project Location</label>
                    <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines">
                </div>

                <div class="input-group">
                    <label>Prepared By</label>
                    <input type="text" id="preparedBy" placeholder="Enter preparer name">
                </div>

                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="projectDate">
                </div>

                <div class="input-group">
                    <label>Unit System</label>
                    <div class="unit-toggle">
                        <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
                        <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
                    </div>
                </div>

                <div class="tab-container">
                    <div class="tabs" role="tablist" aria-label="Project input sections">
                        <div class="tab active" role="tab" aria-selected="true" aria-controls="general-tab" data-tab="general" id="tab-general">General Parameters</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="pipes-tab" data-tab="pipes" id="tab-pipes">Pipes & Fittings</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="help-tab" data-tab="help" id="tab-help">Help & Reference</div>
                    </div>

                    <div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
                        <div class="input-row">
                            <div class="input-group">
                                <label class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for electrician labor</span></label>
                                <input type="number" id="laborRate" value="250" step="0.01" min="0">
                                <div class="error-message" id="laborRateError">Labor rate must be positive</div>
                                <div class="unit-label currency-unit">PHP/hour</div>
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
                                <input type="number" id="overheadRate" value="15" step="0.1" min="0" max="100">
                                <div class="error-message" id="overheadRateError">Overhead rate must be between 0-100%</div>
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
                                <input type="number" id="profitMarginRate" value="20" step="0.1" min="0" max="100">
                                <div class="error-message" id="profitMarginError">Profit margin must be between 0-100%</div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Currency</label>
                                <select id="currency">
                                    <option value="PHP">Philippine Peso (PHP)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="JPY">Japanese Yen (¥)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="pipes-tab" role="tabpanel" aria-labelledby="tab-pipes">
                        <div class="input-group">
                            <label>Conduit Type</label>
                            <select id="conduitType">
                                <option value="PVC">PVC</option>
                                <option value="EMT">EMT</option>
                            </select>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">
                                <span>Pipes</span>
                                <button class="btn btn-primary btn-sm" id="addPipeBtn">Add Pipe</button>
                            </div>
                            <div id="pipesContainer">
                                <!-- Dynamic pipes will be added here -->
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">
                                <span>Couplings</span>
                                <button class="btn btn-primary btn-sm" id="addCouplingBtn">Add Coupling</button>
                            </div>
                            <div id="couplingsContainer">
                                <!-- Dynamic couplings will be added here -->
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">
                                <span>Elbows</span>
                                <button class="btn btn-primary btn-sm" id="addElbowBtn">Add Elbow</button>
                            </div>
                            <div id="elbowsContainer">
                                <!-- Dynamic elbows will be added here -->
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">
                                <span>Connectors</span>
                                <button class="btn btn-primary btn-sm" id="addConnectorBtn">Add Connector</button>
                            </div>
                            <div id="connectorsContainer">
                                <!-- Dynamic connectors will be added here -->
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">
                                <span>Locknuts & Bushings</span>
                                <button class="btn btn-primary btn-sm" id="addLocknutBtn">Add Locknut/Bushing</button>
                            </div>
                            <div id="locknutsContainer">
                                <!-- Dynamic locknuts will be added here -->
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="help-tab" role="tabpanel" aria-labelledby="tab-help">
                        <div class="help-section how-to-use">
                            <h3>How to Use This Calculator</h3>
                            <div class="step-guide">
                                <p><span class="step-number">1</span> <strong>Project Information:</strong> Enter project details like name, client, location, and date.</p>
                                <p><span class="step-number">2</span> <strong>Unit System:</strong> Choose between Imperial (feet) or Metric (meters) units.</p>
                                <p><span class="step-number">3</span> <strong>General Parameters:</strong> Set labor rate, overhead, profit margin, and currency.</p>
                                <p><span class="step-number">4</span> <strong>Pipes & Fittings:</strong> Select conduit type and add items for each category with specific sizes.</p>
                                <p><span class="step-number">5</span> <strong>Calculate:</strong> Click "Calculate" to generate the cost breakdown and labor requirements.</p>
                                <p><span class="step-number">6</span> <strong>Export:</strong> Export results as PDF or Excel for professional use.</p>
                            </div>
                        </div>

                        <div class="help-section calculation-formulas">
                            <h3>Calculation Formulas</h3>
                            <div class="formula-box">
                                <h4>Direct Costs:</h4>
                                <p><strong>Material Cost</strong> = Quantity × Unit Cost</p>
                                <p><strong>Labor Cost</strong> = Labor Hours × Labor Rate</p>
                                <p><strong>Total Direct Cost</strong> = Sum of Material and Labor Costs</p>
                                <h4>Indirect Costs:</h4>
                                <p><strong>Overhead Cost</strong> = Total Direct Cost × Overhead Rate</p>
                                <h4>Profit:</h4>
                                <p><strong>Profit</strong> = (Direct Cost + Overhead) × Profit Margin Rate</p>
                                <p><strong>Final Cost</strong> = Direct Cost + Overhead + Profit</p>
                            </div>
                        </div>

                        <div class="help-section standard-sizes">
                            <h3>Standard Sizes</h3>
                            <div class="reference-box">
                                <h4>PVC Conduit Sizes:</h4>
                                <ul>
                                    <li>Pipes: 20mm, 25mm, 40mm, 50mm, 75mm, 90mm, 100mm, 200mm</li>
                                    <li>Couplings: 20mm, 25mm, 40mm, 50mm, 75mm, 90mm, 100mm</li>
                                    <li>Elbows: 20mm, 25mm, 40mm, 50mm, 75mm, 90mm, 100mm</li>
                                    <li>Locknuts & Bushings: 20mm, 25mm, 40mm, 50mm, 75mm, 90mm, 100mm</li>
                                </ul>
                                <h4>EMT Conduit Sizes:</h4>
                                <ul>
                                    <li>Pipes: 15mm, 20mm, 25mm, 40mm, 50mm</li>
                                    <li>Couplings: 15mm, 20mm, 25mm, 40mm, 50mm</li>
                                    <li>Connectors: 15mm, 20mm, 25mm, 40mm, 50mm</li>
                                    <li>Locknuts & Bushings: 15mm, 20mm, 25mm, 40mm, 50mm</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="validation-error" id="validationError">
                        Please check your inputs. Some values are missing or invalid.
                    </div>

                    <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; margin-top: 20px;">
                        Calculate
                    </button>
                </div>
            </div>

            <div class="output-section">
                <h2 class="section-title">Estimate Results</h2>

                <div id="resultsPlaceholder">
                    <p>Enter your project details and click "Calculate" to see results.</p>
                </div>

                <div id="resultsContent" class="hidden">
                    <h3>Project: <span id="resultProjectName"></span></h3>
                    <p><strong>Client:</strong> <span id="resultClientName"></span></p>
                    <p><strong>Location:</strong> <span id="resultProjectLocation"></span></p>
                    <p><strong>Prepared By:</strong> <span id="resultPreparedBy"></span></p>
                    <p><strong>Date:</strong> <span id="resultProjectDate"></span></p>

                    <h4 style="margin-top: 20px;">Bill of Quantity</h4>
                    <table class="bill-of-quantity-table" id="billOfQuantityTable">
                        <thead>
                            <tr>
                                <th class="text-center">Item No.</th>
                                <th>Scope of Work</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="billOfQuantityTableBody"></tbody>
                    </table>

                    <h4 style="margin-top: 20px;">Indirect Costs & Markup</h4>
                    <table class="bill-of-quantity-table">
                        <thead>
                            <tr>
                                <th class="text-center">Item No.</th>
                                <th>Scope of Work</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="indirectCostsTableBody"></tbody>
                    </table>

                    <h4 style="margin-top: 20px;">Summary</h4>
                    <table class="bill-of-quantity-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody"></tbody>
                    </table>

                    <div id="crewSizingSection" class="crew-sizing hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUnitSystem = 'metric'; // Changed to metric as default
        let projectData = {};
        const FEET_PER_METER = 3.28084;
        const PHP_TO_USD = 0.018;
        const USD_TO_EUR = 0.85;
        const USD_TO_JPY = 110;

        // Material price database (USD and PHP, 2025 averages)
        const materials = {
            PVC: {
                pipes: {
                    '20mm': { cost_per_foot: 1.20, cost_per_meter: 3.94, labor_hours_per_100ft: 2.0 },
                    '25mm': { cost_per_foot: 1.50, cost_per_meter: 4.92, labor_hours_per_100ft: 2.2 },
                    '40mm': { cost_per_foot: 2.00, cost_per_meter: 6.56, labor_hours_per_100ft: 2.5 },
                    '50mm': { cost_per_foot: 2.50, cost_per_meter: 8.20, labor_hours_per_100ft: 2.8 },
                    '75mm': { cost_per_foot: 3.50, cost_per_meter: 11.48, labor_hours_per_100ft: 3.2 },
                    '90mm': { cost_per_foot: 4.50, cost_per_meter: 14.76, labor_hours_per_100ft: 3.5 },
                    '100mm': { cost_per_foot: 5.00, cost_per_meter: 16.40, labor_hours_per_100ft: 3.8 },
                    '200mm': { cost_per_foot: 8.00, cost_per_meter: 26.24, labor_hours_per_100ft: 5.0 }
                },
                couplings: {
                    '20mm': { cost: 0.80, labor_hours: 0.08 },
                    '25mm': { cost: 1.00, labor_hours: 0.08 },
                    '40mm': { cost: 1.20, labor_hours: 0.09 },
                    '50mm': { cost: 1.50, labor_hours: 0.09 },
                    '75mm': { cost: 2.00, labor_hours: 0.10 },
                    '90mm': { cost: 2.50, labor_hours: 0.10 },
                    '100mm': { cost: 3.00, labor_hours: 0.11 }
                },
                elbows: {
                    '20mm': { cost: 1.50, labor_hours: 0.10 },
                    '25mm': { cost: 1.80, labor_hours: 0.10 },
                    '40mm': { cost: 2.20, labor_hours: 0.11 },
                    '50mm': { cost: 2.50, labor_hours: 0.11 },
                    '75mm': { cost: 3.50, labor_hours: 0.12 },
                    '90mm': { cost: 4.50, labor_hours: 0.12 },
                    '100mm': { cost: 5.00, labor_hours: 0.13 }
                },
                connectors: {
                    '20mm': { cost: 1.20, labor_hours: 0.09 },
                    '25mm': { cost: 1.40, labor_hours: 0.09 },
                    '40mm': { cost: 1.60, labor_hours: 0.10 },
                    '50mm': { cost: 1.80, labor_hours: 0.10 },
                    '75mm': { cost: 2.20, labor_hours: 0.11 },
                    '90mm': { cost: 2.60, labor_hours: 0.11 },
                    '100mm': { cost: 3.00, labor_hours: 0.12 }
                },
                locknuts: {
                    '20mm': { cost: 0.50, labor_hours: 0.05 },
                    '25mm': { cost: 0.60, labor_hours: 0.05 },
                    '40mm': { cost: 0.70, labor_hours: 0.06 },
                    '50mm': { cost: 0.80, labor_hours: 0.06 },
                    '75mm': { cost: 1.00, labor_hours: 0.07 },
                    '90mm': { cost: 1.20, labor_hours: 0.07 },
                    '100mm': { cost: 1.50, labor_hours: 0.08 }
                }
            },
            EMT: {
                pipes: {
                    '15mm': { cost_per_foot: 1.80, cost_per_meter: 5.90, labor_hours_per_100ft: 2.2 },
                    '20mm': { cost_per_foot: 2.20, cost_per_meter: 7.22, labor_hours_per_100ft: 2.4 },
                    '25mm': { cost_per_foot: 2.80, cost_per_meter: 9.18, labor_hours_per_100ft: 2.6 },
                    '40mm': { cost_per_foot: 3.75, cost_per_meter: 12.30, labor_hours_per_100ft: 2.8 },
                    '50mm': { cost_per_foot: 4.50, cost_per_meter: 14.76, labor_hours_per_100ft: 3.0 }
                },
                couplings: {
                    '15mm': { cost: 1.20, labor_hours: 0.09 },
                    '20mm': { cost: 1.40, labor_hours: 0.09 },
                    '25mm': { cost: 1.60, labor_hours: 0.10 },
                    '40mm': { cost: 1.80, labor_hours: 0.10 },
                    '50mm': { cost: 2.00, labor_hours: 0.11 }
                },
                elbows: {
                    '15mm': { cost: 1.50, labor_hours: 0.10 },
                    '20mm': { cost: 1.70, labor_hours: 0.10 },
                    '25mm': { cost: 1.90, labor_hours: 0.11 },
                    '40mm': { cost: 2.10, labor_hours: 0.11 },
                    '50mm': { cost: 2.30, labor_hours: 0.12 }
                },
                connectors: {
                    '15mm': { cost: 1.50, labor_hours: 0.10 },
                    '20mm': { cost: 1.70, labor_hours: 0.10 },
                    '25mm': { cost: 1.90, labor_hours: 0.11 },
                    '40mm': { cost: 2.10, labor_hours: 0.11 },
                    '50mm': { cost: 2.30, labor_hours: 0.12 }
                },
                locknuts: {
                    '15mm': { cost: 0.60, labor_hours: 0.06 },
                    '20mm': { cost: 0.70, labor_hours: 0.06 },
                    '25mm': { cost: 0.80, labor_hours: 0.07 },
                    '40mm': { cost: 0.90, labor_hours: 0.07 },
                    '50mm': { cost: 1.00, labor_hours: 0.08 }
                }
            }
        };

        // DOM elements
        const unitButtons = document.querySelectorAll('.unit-btn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const validationError = document.getElementById('validationError');
        const resultsPlaceholder = document.getElementById('resultsPlaceholder');
        const resultsContent = document.getElementById('resultsContent');
        const crewSizingSection = document.getElementById('crewSizingSection');

        // Add item buttons
        const addPipeBtn = document.getElementById('addPipeBtn');
        const addCouplingBtn = document.getElementById('addCouplingBtn');
        const addElbowBtn = document.getElementById('addElbowBtn');
        const addConnectorBtn = document.getElementById('addConnectorBtn');
        const addLocknutBtn = document.getElementById('addLocknutBtn');

        // Containers for dynamic items
        const pipesContainer = document.getElementById('pipesContainer');
        const couplingsContainer = document.getElementById('couplingsContainer');
        const elbowsContainer = document.getElementById('elbowsContainer');
        const connectorsContainer = document.getElementById('connectorsContainer');
        const locknutsContainer = document.getElementById('locknutsContainer');

        // Initialize date to today
        document.getElementById('projectDate').valueAsDate = new Date();

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing calculator');
            
            // Unit system toggle
            unitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const newUnit = this.getAttribute('data-unit');
                    if (newUnit !== currentUnitSystem) {
                        convertUnits(newUnit);
                    }
                    unitButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentUnitSystem = newUnit;
                    updateUnitLabels();
                    updateConduitCosts(); // Update costs when unit changes
                });
            });

            // Tab navigation
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tabContents.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });

            // Calculate button
            calculateBtn.addEventListener('click', function() {
                console.log('Calculate button clicked');
                calculateEstimate();
            });

            // Reset button
            resetBtn.addEventListener('click', resetCalculator);

            // Export buttons
            exportPdfBtn.addEventListener('click', exportToPdf);
            exportExcelBtn.addEventListener('click', exportToExcel);

            // Add item buttons
            addPipeBtn.addEventListener('click', function() { 
                console.log('Add pipe clicked');
                addItem('pipes'); 
            });
            addCouplingBtn.addEventListener('click', function() { addItem('couplings'); });
            addElbowBtn.addEventListener('click', function() { addItem('elbows'); });
            addConnectorBtn.addEventListener('click', function() { addItem('connectors'); });
            addLocknutBtn.addEventListener('click', function() { addItem('locknuts'); });

            // Conduit type change
            document.getElementById('conduitType').addEventListener('change', updateConduitType);

            // Input validation and currency update
            setupInputValidation();
            document.getElementById('currency').addEventListener('change', updateCurrency);
            updateCurrency();
            
            // Add initial items
            addItem('pipes');
            addItem('couplings');
            addItem('elbows');
            addItem('connectors');
            addItem('locknuts');
            
            console.log('Calculator initialized successfully');
        });

        // Utility functions
        function safeNumber(v, fallback = 0) {
            if (v === "" || v === null || v === undefined) return fallback;
            const n = Number(v);
            return isNaN(n) ? fallback : n;
        }

        function formatNumber(num, dp = 2) {
            if (typeof num !== 'number' || isNaN(num)) return "0.00";
            const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
            return rounded.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
        }

        function formatCurrency(n) {
            if (typeof n !== 'number' || isNaN(n)) return "PHP 0.00";
            const c = document.getElementById('currency').value;
            let symbol = '';
            switch (c) {
                case 'PHP': symbol = 'PHP'; break;
                case 'USD': symbol = '$'; break;
                case 'EUR': symbol = '€'; break;
                case 'JPY': symbol = '¥'; break;
                default: symbol = c + ' ';
            }
            return symbol + ' ' + formatNumber(n, 2);
        }

        function updateUnitLabels() {
            const lengthUnit = currentUnitSystem === 'metric' ? 'meters' : 'feet';
            const lengthUnitShort = currentUnitSystem === 'metric' ? 'm' : 'ft';
            
            // Update all unit labels in the UI
            document.querySelectorAll('.length-unit').forEach(unit => {
                unit.textContent = lengthUnit;
            });
            document.querySelectorAll('.length-unit-short').forEach(unit => {
                unit.textContent = lengthUnitShort;
            });
            
            // Update unit labels in dynamic items
            document.querySelectorAll('.item-row').forEach(row => {
                const isPipe = row.dataset.type === 'pipes';
                const unitLabel = row.querySelector('.unit-label');
                if (unitLabel) {
                    if (isPipe) {
                        unitLabel.textContent = lengthUnit;
                    }
                }
            });
            
            updateConduitCosts();
        }

        function updateCurrency() {
            const currency = document.getElementById('currency').value;
            const laborRateInput = document.getElementById('laborRate');
            const currencyUnitLabels = document.querySelectorAll('.currency-unit');

            if (currency === 'PHP') {
                laborRateInput.value = 250;
                currencyUnitLabels.forEach(label => label.textContent = 'PHP/hour');
            } else {
                laborRateInput.value = 45;
                currencyUnitLabels.forEach(label => label.textContent = `${currency}/hour`);
            }
            
            updateConduitCosts();
        }

        function convertUnits(newUnit) {
            const factor = (newUnit === 'imperial' && currentUnitSystem === 'metric') ? FEET_PER_METER :
                (newUnit === 'metric' && currentUnitSystem === 'imperial') ? 1 / FEET_PER_METER : 1;
            if (factor === 1) return;

            // Convert all pipe length values
            document.querySelectorAll('.pipe-length').forEach(input => {
                const currentValue = safeNumber(input.value);
                input.value = formatNumber(currentValue * factor, 2);
            });
            
            updateConduitCosts();
        }

        function updateConduitCosts() {
            const conduitType = document.getElementById('conduitType').value;
            const currency = document.getElementById('currency').value;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const type = row.dataset.type;
                const sizeSelect = row.querySelector('.size-select');
                const costInput = row.querySelector('.cost-input');
                
                if (sizeSelect && costInput) {
                    const size = sizeSelect.value;
                    if (size && materials[conduitType] && materials[conduitType][type] && materials[conduitType][type][size]) {
                        const baseCost = type === 'pipes' ? 
                            (currentUnitSystem === 'metric' ? 
                                materials[conduitType][type][size].cost_per_meter : 
                                materials[conduitType][type][size].cost_per_foot) :
                            materials[conduitType][type][size].cost;
                        
                        const convertedCost = convertCurrency(baseCost, 'USD', currency);
                        costInput.value = formatNumber(convertedCost, 2);
                    }
                }
            });
        }

        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            let usdAmount = amount;
            if (fromCurrency === 'PHP') usdAmount = amount * PHP_TO_USD;
            else if (fromCurrency === 'EUR') usdAmount = amount / USD_TO_EUR;
            else if (fromCurrency === 'JPY') usdAmount = amount / USD_TO_JPY;
            
            if (toCurrency === 'PHP') return usdAmount / PHP_TO_USD;
            else if (toCurrency === 'EUR') return usdAmount * USD_TO_EUR;
            else if (toCurrency === 'JPY') return usdAmount * USD_TO_JPY;
            else return usdAmount;
        }

        function updateConduitType() {
            const conduitType = document.getElementById('conduitType').value;
            
            document.querySelectorAll('.size-select').forEach(select => {
                const type = select.closest('.item-row').dataset.type;
                const currentValue = select.value;
                
                select.innerHTML = '';
                
                if (materials[conduitType] && materials[conduitType][type]) {
                    Object.keys(materials[conduitType][type]).forEach(size => {
                        const option = document.createElement('option');
                        option.value = size;
                        option.textContent = size;
                        select.appendChild(option);
                    });
                    
                    if (materials[conduitType][type][currentValue]) {
                        select.value = currentValue;
                    } else {
                        select.selectedIndex = 0;
                    }
                }
            });
            
            updateConduitCosts();
        }

        function setupInputValidation() {
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateInput(this);
                });
                input.addEventListener('input', function() {
                    if (this.classList.contains('input-error')) {
                        this.classList.remove('input-error');
                        const errorElement = this.nextElementSibling;
                        if (errorElement && errorElement.classList.contains('error-message')) {
                            errorElement.style.display = 'none';
                        }
                    }
                });
            });
        }

        function validateInput(input) {
            let isValid = true;
            let errorMessage = '';

            if (!input.value || isNaN(parseFloat(input.value))) {
                isValid = false;
                errorMessage = 'This field is required and must be a number';
            } else if (input.hasAttribute('min') && parseFloat(input.value) < parseFloat(input.getAttribute('min'))) {
                isValid = false;
                errorMessage = `Value must be at least ${input.getAttribute('min')}`;
            } else if (input.hasAttribute('max') && parseFloat(input.value) > parseFloat(input.getAttribute('max'))) {
                isValid = false;
                errorMessage = `Value must be at most ${input.getAttribute('max')}`;
            } else if (parseFloat(input.value) < 0) {
                isValid = false;
                errorMessage = 'Value cannot be negative';
            }

            if (!isValid) {
                input.classList.add('input-error');
                let errorElement = input.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                }
            } else {
                input.classList.remove('input-error');
                let errorElement = input.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.style.display = 'none';
                }
            }

            return isValid;
        }

        function validateInputs() {
            let isValid = true;
            
            const projectName = document.getElementById('projectName');
            if (!projectName.value.trim()) {
                projectName.classList.add('input-error');
                document.getElementById('projectNameError').style.display = 'block';
                isValid = false;
            } else {
                projectName.classList.remove('input-error');
                document.getElementById('projectNameError').style.display = 'none';
            }

            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                if (!validateInput(input)) {
                    isValid = false;
                }
            });

            const hasItems = document.querySelectorAll('.item-row').length > 0;
            if (!hasItems) {
                validationError.textContent = "Please add at least one item";
                validationError.style.display = 'block';
                isValid = false;
            } else {
                let hasValidItems = false;
                document.querySelectorAll('.item-row').forEach(row => {
                    const quantityInput = row.querySelector('.pipe-length') || row.querySelector('.item-quantity');
                    if (quantityInput && safeNumber(quantityInput.value) > 0) {
                        hasValidItems = true;
                    }
                });
                
                if (!hasValidItems) {
                    validationError.textContent = "Please add at least one item with quantity greater than 0";
                    validationError.style.display = 'block';
                    isValid = false;
                } else {
                    validationError.style.display = 'none';
                }
            }

            return isValid;
        }

        // Dynamic item management
        function addItem(type) {
            console.log(`Adding item: ${type}`);
            const conduitType = document.getElementById('conduitType').value;
            const container = document.getElementById(`${type}Container`);
            const itemId = `${type}_${Date.now()}`;
            
            const sizes = materials[conduitType] && materials[conduitType][type] ? 
                Object.keys(materials[conduitType][type]) : [];
            
            const sizeOptions = sizes.map(size => 
                `<option value="${size}">${size}</option>`
            ).join('');
            
            const isPipe = type === 'pipes';
            const lengthLabel = isPipe ? 'Length' : 'Quantity';
            const lengthUnit = isPipe ? 
                (currentUnitSystem === 'metric' ? 'meters' : 'feet') : 
                'pcs';
            const costUnit = isPipe ? 
                (currentUnitSystem === 'metric' ? 'currency/m' : 'currency/ft') : 
                'currency';
            
            const itemHTML = `
                <div class="input-row-dynamic item-row" data-type="${type}" id="${itemId}">
                    <div class="input-group">
                        <label>Size</label>
                        <select class="size-select">
                            ${sizeOptions}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>${lengthLabel}</label>
                        <input type="number" class="${isPipe ? 'pipe-length' : 'item-quantity'}" value="0" min="0" step="0.1">
                        <div class="unit-label">${lengthUnit}</div>
                    </div>
                    <div class="input-group">
                        <label>Unit Cost</label>
                        <input type="number" class="cost-input" value="0" step="0.01" min="0">
                        <div class="unit-label">${costUnit}</div>
                    </div>
                    <div class="input-group">
                        <label>Labor Hours per Unit</label>
                        <input type="number" class="labor-hours-input" value="0" step="0.01" min="0">
                        <div class="unit-label">hours</div>
                    </div>
                    <div class="input-group">
                        <button class="remove-btn" type="button" onclick="removeItem('${itemId}')">Remove</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHTML);
            
            // Add event listeners to the new item
            const newItem = document.getElementById(itemId);
            const sizeSelect = newItem.querySelector('.size-select');
            const costInput = newItem.querySelector('.cost-input');
            const laborInput = newItem.querySelector('.labor-hours-input');
            
            sizeSelect.addEventListener('change', function() {
                updateItemCost(this);
            });
            
            // Set initial values
            if (sizeSelect.value && materials[conduitType] && materials[conduitType][type] && materials[conduitType][type][sizeSelect.value]) {
                const itemData = materials[conduitType][type][sizeSelect.value];
                const currency = document.getElementById('currency').value;
                
                const baseCost = isPipe ? 
                    (currentUnitSystem === 'metric' ? itemData.cost_per_meter : itemData.cost_per_foot) :
                    itemData.cost;
                
                const convertedCost = convertCurrency(baseCost, 'USD', currency);
                costInput.value = formatNumber(convertedCost, 2);
                
                if (isPipe) {
                    laborInput.value = formatNumber(itemData.labor_hours_per_100ft / 100, 3);
                } else {
                    laborInput.value = formatNumber(itemData.labor_hours, 2);
                }
            }

            const newInputs = newItem.querySelectorAll('input[type="number"]');
            newInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateInput(this);
                });
            });
            
            console.log(`Item ${itemId} added successfully`);
        }

        function removeItem(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        function updateItemCost(selectElement) {
            const row = selectElement.closest('.item-row');
            const type = row.dataset.type;
            const size = selectElement.value;
            const conduitType = document.getElementById('conduitType').value;
            const currency = document.getElementById('currency').value;
            const costInput = row.querySelector('.cost-input');
            const laborInput = row.querySelector('.labor-hours-input');
            
            if (size && materials[conduitType] && materials[conduitType][type] && materials[conduitType][type][size]) {
                const itemData = materials[conduitType][type][size];
                const isPipe = type === 'pipes';
                
                const baseCost = isPipe ? 
                    (currentUnitSystem === 'metric' ? itemData.cost_per_meter : itemData.cost_per_foot) :
                    itemData.cost;
                
                const convertedCost = convertCurrency(baseCost, 'USD', currency);
                costInput.value = formatNumber(convertedCost, 2);
                
                if (isPipe) {
                    laborInput.value = formatNumber(itemData.labor_hours_per_100ft / 100, 3);
                } else {
                    laborInput.value = formatNumber(itemData.labor_hours, 2);
                }
            }
        }

        function calculateEstimate() {
            console.log('Starting calculation...');
            if (!validateInputs()) {
                console.log('Validation failed');
                return;
            }

            const conduitType = document.getElementById('conduitType').value;
            const laborRate = safeNumber(document.getElementById('laborRate').value, 250);
            const overheadRate = safeNumber(document.getElementById('overheadRate').value, 15) / 100;
            const profitMarginRate = safeNumber(document.getElementById('profitMarginRate').value, 20) / 100;
            const currency = document.getElementById('currency').value;

            const workItems = [];
            
            // Process pipes
            document.querySelectorAll('.item-row[data-type="pipes"]').forEach(row => {
                const sizeSelect = row.querySelector('.size-select');
                const lengthInput = row.querySelector('.pipe-length');
                const costInput = row.querySelector('.cost-input');
                const laborInput = row.querySelector('.labor-hours-input');
                
                if (sizeSelect.value && safeNumber(lengthInput.value) > 0) {
                    workItems.push({
                        name: `${conduitType} Pipe (${sizeSelect.value})`,
                        quantity: safeNumber(lengthInput.value, 0),
                        unit: currentUnitSystem === 'metric' ? 'meters' : 'feet',
                        unitCost: safeNumber(costInput.value, 0),
                        laborHoursPerUnit: safeNumber(laborInput.value, 0),
                        laborHours: safeNumber(lengthInput.value, 0) * safeNumber(laborInput.value, 0)
                    });
                }
            });
            
            // Process other items
            const otherTypes = ['couplings', 'elbows', 'connectors', 'locknuts'];
            otherTypes.forEach(type => {
                document.querySelectorAll(`.item-row[data-type="${type}"]`).forEach(row => {
                    const sizeSelect = row.querySelector('.size-select');
                    const quantityInput = row.querySelector('.item-quantity');
                    const costInput = row.querySelector('.cost-input');
                    const laborInput = row.querySelector('.labor-hours-input');
                    
                    if (sizeSelect.value && safeNumber(quantityInput.value) > 0) {
                        const itemName = type === 'locknuts' ? 
                            `${conduitType} Locknut/Bushing (${sizeSelect.value})` :
                            `${conduitType} ${type.charAt(0).toUpperCase() + type.slice(1)} (${sizeSelect.value})`;
                        
                        workItems.push({
                            name: itemName,
                            quantity: safeNumber(quantityInput.value, 0),
                            unit: 'pcs',
                            unitCost: safeNumber(costInput.value, 0),
                            laborHoursPerUnit: safeNumber(laborInput.value, 0),
                            laborHours: safeNumber(quantityInput.value, 0) * safeNumber(laborInput.value, 0)
                        });
                    }
                });
            });

            if (workItems.length === 0) {
                validationError.textContent = "Please add at least one item with quantity greater than 0";
                validationError.style.display = 'block';
                return;
            }

            let totalMaterialCost = 0;
            let totalLaborHours = 0;
            let totalLaborCost = 0;

            workItems.forEach(item => {
                item.materialCost = item.quantity * item.unitCost;
                item.laborCost = item.laborHours * laborRate;
                item.totalCost = item.materialCost + item.laborCost;
                totalMaterialCost += item.materialCost;
                totalLaborHours += item.laborHours;
                totalLaborCost += item.laborCost;
            });

            const totalDirectCost = totalMaterialCost + totalLaborCost;
            const overheadCost = totalDirectCost * overheadRate;
            const costBeforeProfit = totalDirectCost + overheadCost;
            const profit = costBeforeProfit * profitMarginRate;
            const finalPrice = costBeforeProfit + profit;

            projectData = {
                projectName: document.getElementById('projectName').value || 'Unnamed Project',
                clientName: document.getElementById('clientName').value,
                projectLocation: document.getElementById('projectLocation').value,
                preparedBy: document.getElementById('preparedBy').value,
                projectDate: document.getElementById('projectDate').value,
                timestamp: new Date().toISOString(),
                unitSystem: currentUnitSystem,
                currency: currency,
                parameters: {
                    laborRate,
                    overheadRate: overheadRate * 100,
                    profitMarginRate: profitMarginRate * 100
                },
                workItems,
                totals: {
                    totalMaterialCost,
                    totalLaborHours,
                    totalLaborCost,
                    totalDirectCost,
                    overheadCost,
                    profit,
                    finalPrice
                }
            };

            console.log('Calculation completed successfully', projectData);
            displayResults(workItems, totalDirectCost, overheadCost, profit, totalLaborHours, currency);
        }

        function displayResults(workItems, totalDirectCost, overheadCost, profit, totalLaborHours, currency) {
            console.log('Displaying results...');
            
            document.getElementById('resultProjectName').textContent = projectData.projectName;
            document.getElementById('resultClientName').textContent = projectData.clientName || 'Not specified';
            document.getElementById('resultProjectLocation').textContent = projectData.projectLocation || 'Not specified';
            document.getElementById('resultPreparedBy').textContent = projectData.preparedBy || 'Not specified';
            document.getElementById('resultProjectDate').textContent = projectData.projectDate || 'Not specified';

            const billOfQuantityTableBody = document.getElementById('billOfQuantityTableBody');
            billOfQuantityTableBody.innerHTML = "";
            let itemNo = 1;

            workItems.forEach(item => {
                if (item.quantity > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center">${itemNo++}</td>
                        <td>${item.name}</td>
                        <td class="text-center">${formatNumber(item.quantity)}</td>
                        <td class="text-center">${item.unit}</td>
                        <td class="text-right">${formatCurrency(item.materialCost)}</td>
                        <td class="text-right">${formatNumber(item.laborHours, 1)}</td>
                        <td class="text-right">${formatCurrency(item.laborCost)}</td>
                        <td class="text-right">${formatCurrency(item.totalCost)}</td>
                    `;
                    billOfQuantityTableBody.appendChild(row);
                }
            });

            const totalDirectRow = document.createElement('tr');
            totalDirectRow.className = 'total-row';
            totalDirectRow.innerHTML = `
                <td class="text-center"></td>
                <td><strong>TOTAL DIRECT COSTS</strong></td>
                <td class="text-center"></td>
                <td class="text-center"></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalMaterialCost)}</strong></td>
                <td class="text-right"><strong>${formatNumber(totalLaborHours, 1)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalLaborCost)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalDirectCost)}</strong></td>
            `;
            billOfQuantityTableBody.appendChild(totalDirectRow);

            const indirectCostsTableBody = document.getElementById('indirectCostsTableBody');
            indirectCostsTableBody.innerHTML = "";

            const overheadRow = document.createElement('tr');
            overheadRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Overhead (${projectData.parameters.overheadRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(overheadCost)}</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatCurrency(overheadCost)}</td>
            `;
            indirectCostsTableBody.appendChild(overheadRow);

            const profitRow = document.createElement('tr');
            profitRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Profit Margin (${projectData.parameters.profitMarginRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(profit)}</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatCurrency(profit)}</td>
            `;
            indirectCostsTableBody.appendChild(profitRow);

            const totalIndirectRow = document.createElement('tr');
            totalIndirectRow.className = 'total-row';
            totalIndirectRow.innerHTML = `
                <td class="text-center">-</td>
                <td><strong>TOTAL INDIRECT COSTS & MARKUP</strong></td>
                <td class="text-center">-</td>
                <td class="text-center">-</td>
                <td class="text-right"><strong>${formatCurrency(overheadCost + profit)}</strong></td>
                <td class="text-right"><strong>-</strong></td>
                <td class="text-right"><strong>-</strong></td>
                <td class="text-right"><strong>${formatCurrency(overheadCost + profit)}</strong></td>
            `;
            indirectCostsTableBody.appendChild(totalIndirectRow);

            const summaryTableBody = document.getElementById('summaryTableBody');
            summaryTableBody.innerHTML = '';

            const directRow = document.createElement('tr');
            directRow.innerHTML = `
                <td>Total Direct Costs</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalMaterialCost)}</td>
                <td class="text-right">${formatNumber(totalLaborHours, 1)}</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalLaborCost)}</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalDirectCost)}</td>
            `;
            summaryTableBody.appendChild(directRow);

            const indirectRow = document.createElement('tr');
            indirectRow.innerHTML = `
                <td>Total Indirect Costs & Markup</td>
                <td class="text-right">${formatCurrency(overheadCost + profit)}</td>
                <td class="text-right"></td>
                <td class="text-right"></td>
                <td class="text-right">${formatCurrency(overheadCost + profit)}</td>
            `;
            summaryTableBody.appendChild(indirectRow);

            const finalRow = document.createElement('tr');
            finalRow.className = 'total-row';
            finalRow.innerHTML = `
                <td><strong>GRAND TOTAL</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalMaterialCost + overheadCost + profit)}</strong></td>
                <td class="text-right"><strong>${formatNumber(totalLaborHours, 1)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalLaborCost)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.finalPrice)}</strong></td>
            `;
            summaryTableBody.appendChild(finalRow);

            addCrewSizingSummary(totalLaborHours, currency);

            resultsPlaceholder.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            
            console.log('Results displayed successfully');
        }

        function addCrewSizingSummary(totalLaborHours, currency) {
            const laborRate = safeNumber(document.getElementById('laborRate').value, 250);
            const HOURS_PER_DAY = 8;
            const DAYS_PER_WEEK = 5;
            const totalLaborDays = totalLaborHours / HOURS_PER_DAY;
            const totalWeeks = totalLaborDays / DAYS_PER_WEEK;

            const smallCrew = 2;
            const mediumCrew = 4;
            const largeCrew = 6;

            const smallCrewDays = totalLaborDays / smallCrew;
            const mediumCrewDays = totalLaborDays / mediumCrew;
            const largeCrewDays = totalLaborDays / largeCrew;

            const smallCrewWeeks = smallCrewDays / DAYS_PER_WEEK;
            const mediumCrewWeeks = mediumCrewDays / DAYS_PER_WEEK;
            const largeCrewWeeks = largeCrewDays / DAYS_PER_WEEK;

            crewSizingSection.innerHTML = `
                <h4 style="margin-bottom: 15px;">Labor & Crew Planning</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="cost-card">
                        <div>Total Labor Hours</div>
                        <div class="cost-value">${formatNumber(totalLaborHours, 1)}</div>
                        <div>hours</div>
                    </div>
                    <div class="cost-card">
                        <div>Total Labor Cost</div>
                        <div class="cost-value">${formatCurrency(totalLaborHours * laborRate)}</div>
                        <div>${currency}</div>
                    </div>
                    <div class="cost-card">
                        <div>Equivalent Work Days</div>
                        <div class="cost-value">${formatNumber(totalLaborDays, 1)}</div>
                        <div>days (8h/day)</div>
                    </div>
                </div>
                <h5 style="margin-bottom: 10px;">Recommended Crew Sizes & Timelines:</h5>
                <div class="crew-options">
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--success);">Small Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${smallCrew} workers</div>
                        <div>${formatNumber(smallCrewDays, 1)} days</div>
                        <div>${formatNumber(smallCrewWeeks, 1)} weeks</div>
                    </div>
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--warning);">Medium Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${mediumCrew} workers</div>
                        <div>${formatNumber(mediumCrewDays, 1)} days</div>
                        <div>${formatNumber(mediumCrewWeeks, 1)} weeks</div>
                    </div>
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--danger);">Large Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${largeCrew} workers</div>
                        <div>${formatNumber(largeCrewDays, 1)} days</div>
                        <div>${formatNumber(largeCrewWeeks, 1)} weeks</div>
                    </div>
                </div>
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <strong>Note:</strong> Based on ${HOURS_PER_DAY} hours per day, ${DAYS_PER_WEEK} days per week.
                    Adjust based on project constraints and safety requirements.
                </div>
            `;
            crewSizingSection.classList.remove("hidden");
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset all inputs? This cannot be undone.')) {
                document.getElementById('projectName').value = '';
                document.getElementById('clientName').value = '';
                document.getElementById('projectLocation').value = '';
                document.getElementById('preparedBy').value = '';
                document.getElementById('projectDate').valueAsDate = new Date();
                
                document.getElementById('laborRate').value = '250';
                document.getElementById('overheadRate').value = '15';
                document.getElementById('profitMarginRate').value = '20';
                document.getElementById('currency').value = 'PHP';
                
                unitButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.unit-btn[data-unit="metric"]').classList.add('active');
                currentUnitSystem = 'metric';
                
                document.getElementById('conduitType').value = 'PVC';
                
                const containers = ['pipesContainer', 'couplingsContainer', 'elbowsContainer', 'connectorsContainer', 'locknutsContainer'];
                containers.forEach(containerId => {
                    document.getElementById(containerId).innerHTML = '';
                });
                
                addItem('pipes');
                addItem('couplings');
                addItem('elbows');
                addItem('connectors');
                addItem('locknuts');
                
                resultsPlaceholder.classList.remove('hidden');
                resultsContent.classList.add('hidden');
                crewSizingSection.classList.add('hidden');
                validationError.style.display = 'none';
                
                document.querySelectorAll('.input-error').forEach(el => {
                    el.classList.remove('input-error');
                });
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                updateUnitLabels();
                updateCurrency();
            }
        }

        // PDF Export Functions
        function getSelectedCurrency() {
            const el = document.getElementById('currency');
            return el ? el.value : 'PHP';
        }

        function getPdfCurrencyPrefix(code) {
            switch (code) {
                case 'PHP': return 'PHP ';
                case 'USD': return '$';
                case 'EUR': return '€';
                case 'JPY': return '¥';
                default:    return code + ' ';
            }
        }

        function formatNumberForPDF(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            return num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatCurrencyForPDF(n) {
            if (typeof n !== 'number' || isNaN(n)) return '0.00';
            const prefix = getPdfCurrencyPrefix(getSelectedCurrency());
            return `${prefix}${n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            if (!projectData?.totals) {
                alert('No results to export. Please calculate an estimate first.');
                return;
            }

            try {
                const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const pageWidth  = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Reserved areas
                const HEADER_H = 65;
                const FOOTER_H = 30;
                const CONTENT_MARGIN_L = 35;
                const CONTENT_MARGIN_R = 35;

                // Common styles
                const BRAND = { r:44, g:62, b:80 }; // #2c3e50
                doc.setFont('helvetica', 'normal');

                // Header/ Footer drawer (runs on every page)
                function drawHeaderFooter(data) {
                    // Header bar
                    doc.setFillColor(240,240,240);
                    doc.rect(0, 0, pageWidth, HEADER_H, 'F');

                    // Title
                    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(BRAND.r,BRAND.g,BRAND.b);
                    doc.text('ELECTRICAL PIPES AND FITTINGS ESTIMATE', pageWidth/2, 24, { align: 'center' });

                    // Meta
                    doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(0);
                    const projectName = document.getElementById('projectName').value || 'Unnamed Project';
                    const clientName  = document.getElementById('clientName').value || 'Not specified';
                    const preparedBy  = document.getElementById('preparedBy').value || 'Not specified';
                    const dateStr     = document.getElementById('projectDate').value || '';

                    doc.text(`Project: ${projectName}`, CONTENT_MARGIN_L, 40);
                    doc.text(`Client: ${clientName}`,  CONTENT_MARGIN_L, 52);
                    doc.text(`Prepared By: ${preparedBy}`, pageWidth - CONTENT_MARGIN_R, 40, { align:'right' });
                    doc.text(`Date: ${dateStr}`,         pageWidth - CONTENT_MARGIN_R, 52, { align:'right' });

                    // Header rule
                    doc.setDrawColor(BRAND.r,BRAND.g,BRAND.b); doc.setLineWidth(0.5);
                    doc.line(CONTENT_MARGIN_L, HEADER_H-6, pageWidth - CONTENT_MARGIN_R, HEADER_H-6);

                    // Footer
                    const pageNumber = doc.internal.getNumberOfPages();
                    doc.setFontSize(8); doc.setTextColor(100);
                    doc.text(`Page ${pageNumber}`, pageWidth/2, pageHeight - 12, { align:'center' });
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, CONTENT_MARGIN_L, pageHeight - 12);
                    doc.text(`Conduit Type: ${document.getElementById('conduitType').value}`, pageWidth - CONTENT_MARGIN_R, pageHeight - 12, { align:'right' });
                }

                // Common AutoTable options
                const TABLE_OPTS = {
                    margin: { left: CONTENT_MARGIN_L, right: CONTENT_MARGIN_R, top: HEADER_H + 6, bottom: FOOTER_H + 6 },
                    styles: {
                        font: 'helvetica',
                        fontSize: 7,
                        cellPadding: 2.5,
                        lineWidth: 0.25,
                        lineColor: 100,
                        overflow: 'linebreak',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [BRAND.r, BRAND.g, BRAND.b],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 7
                    },
                    alternateRowStyles: { fillColor: [245,245,245] },
                    didDrawPage: drawHeaderFooter
                };

                // Section helper
                function sectionTitle(text) {
                    doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(BRAND.r,BRAND.g,BRAND.b);
                    const y = (doc.lastAutoTable?.finalY || (HEADER_H + 12)) + 12;
                    doc.text(text, CONTENT_MARGIN_L, y);
                    return y + 4;
                }

                // Column widths (total: 22+135+40+28+70+50+70+80 = 495pt)
                const w = {
                    itemNo: 22,
                    scope: 135,  
                    qty: 40,
                    unit: 28,
                    mat: 70,
                    hrs: 50,
                    lab: 70,
                    tot: 80
                };

                // ===== Bill of Quantity =====
                let startY = sectionTitle('BILL OF QUANTITY');
                const boqHead = [['Item No.','Scope of Work','Quantity','Unit','Material Cost','Labor Hours','Labor Cost','Total Cost']];
                const boqBody = [];
                let itemNo = 1;

                // Add work items
                projectData.workItems.forEach(item => {
                    if (item.quantity > 0) {
                        boqBody.push([
                            String(itemNo++),
                            item.name,
                            formatNumberForPDF(item.unit === 'pcs' ? Math.round(item.quantity) : item.quantity, item.unit === 'pcs' ? 0 : 2),
                            item.unit,
                            formatCurrencyForPDF(item.materialCost),
                            formatNumberForPDF(item.laborHours, 1),
                            formatCurrencyForPDF(item.laborCost),
                            formatCurrencyForPDF(item.totalCost)
                        ]);
                    }
                });

                // Add total direct costs row
                boqBody.push([
                    '', 'TOTAL DIRECT COSTS', '', '',
                    formatCurrencyForPDF(projectData.totals.totalMaterialCost),
                    formatNumberForPDF(projectData.totals.totalLaborHours, 1),
                    formatCurrencyForPDF(projectData.totals.totalLaborCost),
                    formatCurrencyForPDF(projectData.totals.totalDirectCost)
                ]);

                doc.autoTable({
                    ...TABLE_OPTS,
                    startY,
                    head: boqHead,
                    body: boqBody,
                    columnStyles: {
                        0:{ cellWidth: w.itemNo, halign:'center' },
                        1:{ cellWidth: w.scope, cellPadding: 2 },
                        2:{ cellWidth: w.qty, halign:'right' },
                        3:{ cellWidth: w.unit, halign:'center' },
                        4:{ cellWidth: w.mat, halign:'right' },
                        5:{ cellWidth: w.hrs, halign:'right' },
                        6:{ cellWidth: w.lab, halign:'right' },
                        7:{ cellWidth: w.tot, halign:'right' }
                    },
                    didParseCell(data) {
                        // Bold last row (TOTAL)
                        if (data.section === 'body' && data.row.index === boqBody.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                        }
                        // Ensure text fits in scope column
                        if (data.column.index === 1 && data.cell.raw.length > 50) {
                            data.cell.styles.fontSize = 6.5;
                        }
                    }
                });

                // ===== Indirect Costs & Markup =====
                startY = sectionTitle('INDIRECT COSTS & MARKUP');
                const indirectBody = [];
                itemNo = 1;

                // Overhead
                indirectBody.push([
                    String(itemNo++),
                    `Overhead (${projectData.parameters.overheadRate}%)`,
                    '1',
                    'lot',
                    formatCurrencyForPDF(projectData.totals.overheadCost),
                    '-',
                    '-',
                    formatCurrencyForPDF(projectData.totals.overheadCost)
                ]);

                // Profit Margin
                indirectBody.push([
                    String(itemNo++),
                    `Profit Margin (${projectData.parameters.profitMarginRate}%)`,
                    '1',
                    'lot',
                    formatCurrencyForPDF(projectData.totals.profit),
                    '-',
                    '-',
                    formatCurrencyForPDF(projectData.totals.profit)
                ]);

                // Total Indirect & Markup
                const totalIndirectMarkup = projectData.totals.overheadCost + projectData.totals.profit;
                indirectBody.push([
                    '',
                    'TOTAL INDIRECT COSTS & MARKUP',
                    '',
                    '',
                    formatCurrencyForPDF(totalIndirectMarkup),
                    '-',
                    '-',
                    formatCurrencyForPDF(totalIndirectMarkup)
                ]);

                doc.autoTable({
                    ...TABLE_OPTS,
                    startY,
                    head: [['Item No.','Scope of Work','Quantity','Unit','Material Cost','Labor Hours','Labor Cost','Total Cost']],
                    body: indirectBody,
                    columnStyles: {
                        0:{ cellWidth: w.itemNo, halign:'center' },
                        1:{ cellWidth: w.scope, cellPadding: 2 },
                        2:{ cellWidth: w.qty, halign:'right' },
                        3:{ cellWidth: w.unit, halign:'center' },
                        4:{ cellWidth: w.mat, halign:'right' },
                        5:{ cellWidth: w.hrs, halign:'right' },
                        6:{ cellWidth: w.lab, halign:'right' },
                        7:{ cellWidth: w.tot, halign:'right' }
                    },
                    didParseCell(data) {
                        if (data.section === 'body' && data.row.index === indirectBody.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                // ===== Summary =====
                startY = sectionTitle('SUMMARY');
                const summaryBody = [
                    [
                        'TOTAL DIRECT COSTS',
                        formatCurrencyForPDF(projectData.totals.totalMaterialCost),
                        formatNumberForPDF(projectData.totals.totalLaborHours, 1),
                        formatCurrencyForPDF(projectData.totals.totalLaborCost),
                        formatCurrencyForPDF(projectData.totals.totalDirectCost)
                    ],
                    [
                        'TOTAL INDIRECT COSTS & MARKUP',
                        formatCurrencyForPDF(totalIndirectMarkup),
                        '',
                        '',
                        formatCurrencyForPDF(totalIndirectMarkup)
                    ],
                    [
                        'GRAND TOTAL',
                        formatCurrencyForPDF(projectData.totals.totalMaterialCost + totalIndirectMarkup),
                        formatNumberForPDF(projectData.totals.totalLaborHours, 1),
                        formatCurrencyForPDF(projectData.totals.totalLaborCost),
                        formatCurrencyForPDF(projectData.totals.finalPrice)
                    ]
                ];

                doc.autoTable({
                    ...TABLE_OPTS,
                    startY,
                    head: [['Category','Material Cost','Labor Hours','Labor Cost','Total Cost']],
                    body: summaryBody,
                    columnStyles: {
                        0:{ cellWidth: w.scope + w.itemNo + 20 }, // Wider for categories
                        1:{ cellWidth: w.mat, halign:'right' },
                        2:{ cellWidth: w.hrs, halign:'right' },
                        3:{ cellWidth: w.lab, halign:'right' },
                        4:{ cellWidth: w.tot, halign:'right' }
                    },
                    didParseCell(data) {
                        if (data.section === 'body' && data.row.index === summaryBody.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                const fileName = (projectData.projectName || 'estimate').replace(/[^a-z0-9]/gi, '_') + '_pipes_fittings_estimate.pdf';
                doc.save(fileName);

            } catch (e) {
                console.error('PDF Generation Error:', e);
                alert('Error generating PDF: ' + e.message);
            }
        }

        function exportToExcel() {
            if (!projectData?.totals) {
                alert('No results to export. Please calculate an estimate first.');
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Main Data Sheet
                const mainData = [
                    // Project Information
                    ['Project:', projectData.projectName || ''],
                    ['Client:', projectData.clientName || ''],
                    ['Location:', projectData.projectLocation || ''],
                    ['Prepared By:', projectData.preparedBy || ''],
                    ['Date:', projectData.projectDate || ''],
                    ['Conduit Type:', document.getElementById('conduitType').value],
                    [], // Empty row
                    
                    // Bill of Quantity Header
                    ['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost'],
                ];

                let itemNo = 1;

                // Bill of Quantity Items
                projectData.workItems.forEach(item => {
                    if (item.quantity > 0) {
                        mainData.push([
                            itemNo++,
                            item.name,
                            item.quantity,
                            item.unit,
                            item.materialCost,
                            item.laborHours,
                            item.laborCost,
                            item.totalCost
                        ]);
                    }
                });

                // Total Direct Costs
                mainData.push([
                    "",
                    "TOTAL DIRECT COSTS",
                    "",
                    "",
                    projectData.totals.totalMaterialCost,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.totalDirectCost
                ]);

                mainData.push([]); // Empty row

                // Indirect Costs & Markup Header
                mainData.push(['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);

                // Overhead
                mainData.push([
                    itemNo++,
                    `Overhead (${projectData.parameters.overheadRate}%)`,
                    1,
                    'lot',
                    projectData.totals.overheadCost,
                    "",
                    "",
                    projectData.totals.overheadCost
                ]);

                // Profit Margin
                mainData.push([
                    itemNo++,
                    `Profit Margin (${projectData.parameters.profitMarginRate}%)`,
                    1,
                    'lot',
                    projectData.totals.profit,
                    "",
                    "",
                    projectData.totals.profit
                ]);

                // Total Indirect & Markup
                const totalIndirectMarkup = projectData.totals.overheadCost + projectData.totals.profit;
                mainData.push([
                    "",
                    "TOTAL INDIRECT COSTS & MARKUP",
                    "",
                    "",
                    totalIndirectMarkup,
                    "",
                    "",
                    totalIndirectMarkup
                ]);

                mainData.push([]); // Empty row

                // Summary Section
                mainData.push(['Category', '', '', '', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);
                
                mainData.push([
                    'TOTAL DIRECT COSTS',
                    '', '', '',
                    projectData.totals.totalMaterialCost,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.totalDirectCost
                ]);

                mainData.push([
                    'TOTAL INDIRECT COSTS & MARKUP',
                    '', '', '',
                    totalIndirectMarkup,
                    "", "",
                    totalIndirectMarkup
                ]);

                mainData.push([
                    'GRAND TOTAL',
                    '', '', '',
                    projectData.totals.totalMaterialCost + totalIndirectMarkup,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.finalPrice
                ]);

                mainData.push([]); // Empty row

                // Labor & Crew Planning Section
                mainData.push(['LABOR & CREW PLANNING']);
                mainData.push(['Total Labor Hours:', projectData.totals.totalLaborHours]);
                mainData.push(['Total Labor Cost:', projectData.totals.totalLaborCost]);
                mainData.push(['Equivalent Work Days:', projectData.totals.totalLaborHours / 8]);
                mainData.push([]);
                
                mainData.push(['Crew Size', 'Workers', 'Days Required', 'Weeks Required', 'Total Hours', 'Daily Hours', 'Notes']);
                
                mainData.push([
                    'Small crew',
                    2,
                    projectData.totals.totalLaborHours / 16,
                    projectData.totals.totalLaborHours / 80,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Basic installation crew'
                ]);

                mainData.push([
                    'Medium crew',
                    4,
                    projectData.totals.totalLaborHours / 32,
                    projectData.totals.totalLaborHours / 160,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Standard project crew'
                ]);

                mainData.push([
                    'Large crew',
                    6,
                    projectData.totals.totalLaborHours / 48,
                    projectData.totals.totalLaborHours / 240,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Accelerated timeline'
                ]);

                const wsMain = XLSX.utils.aoa_to_sheet(mainData);

                // Apply formatting
                const currencyCols = [4, 6, 7]; // Material Cost, Labor Cost, Total Cost columns (0-indexed)
                const numberCols = [2, 5]; // Quantity, Labor Hours columns (0-indexed)

                for (let r = 0; r < mainData.length; r++) {
                    // Currency formatting
                    currencyCols.forEach(col => {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: col});
                        if (wsMain[cellRef] && typeof wsMain[cellRef].v === 'number') {
                            wsMain[cellRef].z = '#,##0.00';
                        }
                    });

                    // Number formatting
                    numberCols.forEach(col => {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: col});
                        if (wsMain[cellRef] && typeof wsMain[cellRef].v === 'number') {
                            wsMain[cellRef].z = col === 5 ? '0.0' : '0';
                        }
                    });
                }

                XLSX.utils.book_append_sheet(wb, wsMain, 'Pipes & Fittings Estimate');

                // Save Excel file
                const safeName = (projectData.projectName || 'project').replace(/[^a-z0-9]/gi, '_');
                XLSX.writeFile(wb, `${safeName}_pipes_fittings_estimate.xlsx`);

            } catch (err) {
                console.error(err);
                alert('Error generating Excel file: ' + err.message);
            }
        }

    </script>
</body>
</html>
