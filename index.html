<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Distribution Systems Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
      --info: #17a2b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
      border-radius: 8px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 2rem;
    }

    @media (max-width: 1024px) {
      .calculator-grid {
        grid-template-columns: 1fr;
      }
    }

    .input-section, .output-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--light);
      color: var(--primary);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    .financial-input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }

    input, select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .unit-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .unit-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: var(--light);
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .unit-btn.active {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    .work-item {
      background: var(--light);
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid var(--secondary);
    }

    .work-item-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .bill-of-quantity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .bill-of-quantity-table th,
    .bill-of-quantity-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .bill-of-quantity-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .bill-of-quantity-table tr:hover {
      background-color: #f5f5f5;
    }

    .total-row {
      font-weight: 600;
      background-color: var(--light) !important;
    }

    .section-header {
      font-weight: 600;
      background-color: #e9ecef;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 1rem;
    }

    .cost-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-top: 4px solid var(--secondary);
    }

    .cost-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin: 10px 0;
    }

    .validation-error {
      color: var(--danger);
      font-size: 0.875rem;
      margin-top: 5px;
      display: none;
    }

    .tab-container {
      margin-bottom: 1rem;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      border-bottom-color: var(--secondary);
      color: var(--secondary);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .export-options {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .hidden {
      display: none;
    }

    .standard-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .standard-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: var(--light);
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .standard-btn.active {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .unit-label {
      font-size: 0.8rem;
      color: #666;
      margin-top: 2px;
    }

    .help-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--success);
    }

    .formula-box {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid var(--secondary);
      font-family: 'Courier New', monospace;
    }

    .reference-box {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid var(--warning);
    }

    .step-guide {
      background: #d1ecf1;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid var(--info);
    }

    .step-number {
      display: inline-block;
      width: 25px;
      height: 25px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 25px;
      margin-right: 10px;
      font-weight: bold;
    }

    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <h1>Power Distribution Systems Calculator</h1>
      <div class="controls">
        <button class="btn btn-primary" id="saveBtn">Save Project</button>
        <button class="btn btn-warning" id="loadBtn">Load Project</button>
        <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
        <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
        <button class="btn btn-danger" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <div class="calculator-grid">
    <div class="input-section">
      <h2 class="section-title">Project Inputs</h2>

      <div class="input-group">
        <label>Project Name</label>
        <input type="text" id="projectName" placeholder="Enter project name" value="Sample Project">
      </div>

      <div class="input-group">
        <label>Unit System</label>
        <div class="unit-toggle">
          <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
          <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
        </div>
      </div>

      <div class="input-group">
        <label>Electrical Standards</label>
        <div class="standard-toggle">
          <div class="standard-btn active" data-standard="philippine">Philippine (PEC)</div>
          <div class="standard-btn" data-standard="international">International (IEC)</div>
        </div>
      </div>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="general">General Parameters</div>
          <div class="tab" data-tab="distribution">Distribution Systems</div>
          <div class="tab" data-tab="cables">Cables & Wiring</div>
          <div class="tab" data-tab="costs">Additional Costs</div>
          <div class="tab" data-tab="help">Help & Reference</div>
        </div>

        <div class="tab-content active" id="general-tab">
          <div class="input-row">
            <div class="input-group">
              <label class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for labor, adjust based on region and standards</span></label>
              <input type="number" id="laborRate" value="250" step="0.01">
              <div class="unit-label">PHP/hour</div>
            </div>
            <div class="input-group">
              <label class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
              <input type="number" id="overheadRate" value="15" step="0.1">
            </div>
            <div class="input-group">
              <label class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
              <input type="number" id="profitMarginRate" value="20" step="0.1">
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label>Currency</label>
              <select id="currency">
                <option value="PHP">Philippine Peso (P)</option>
                <option value="USD">US Dollar ($)</option>
                <option value="EUR">Euro (€)</option>
                <option value="JPY">Japanese Yen (¥)</option>
              </select>
            </div>
            <div class="input-group">
              <label>Project Location</label>
              <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines" value="Manila, Philippines">
            </div>
            <div class="input-group">
              <label>Project Date</label>
              <input type="date" id="projectDate">
            </div>
          </div>
        </div>

        <div class="tab-content" id="distribution-tab">
          <div class="work-item">
            <div class="work-item-title">Main Distribution Boards (MDBs)</div>
            <div class="input-row">
              <div class="input-group">
                <label>Quantity</label>
                <input type="number" id="mdbQty" value="1" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label>Unit Cost</label>
                <input type="number" id="mdbUnitCost" value="50000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Labor Hours per Unit</label>
                <input type="number" id="mdbLaborHours" value="16" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Sub-Main Distribution Boards (SMDBs)</div>
            <div class="input-row">
              <div class="input-group">
                <label>Quantity</label>
                <input type="number" id="smdbQty" value="4" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label>Unit Cost</label>
                <input type="number" id="smdbUnitCost" value="25000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Labor Hours per Unit</label>
                <input type="number" id="smdbLaborHours" value="12" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Distribution Panels</div>
            <div class="input-row">
              <div class="input-group">
                <label>Quantity</label>
                <input type="number" id="panelQty" value="8" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label>Unit Cost</label>
                <input type="number" id="panelUnitCost" value="8000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Labor Hours per Unit</label>
                <input type="number" id="panelLaborHours" value="6" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Circuit Breakers</div>
            <div class="input-row">
              <div class="input-group">
                <label>Quantity</label>
                <input type="number" id="breakerQty" value="24" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label>Unit Cost</label>
                <input type="number" id="breakerUnitCost" value="1200" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Labor Hours per Unit</label>
                <input type="number" id="breakerLaborHours" value="0.5" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="cables-tab">
          <div class="work-item">
            <div class="work-item-title">Power Cables</div>
            <div class="input-row">
              <div class="input-group">
                <label>Length</label>
                <input type="number" id="cableLength" value="500" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label>Cost per Unit</label>
                <input type="number" id="cableCostPerUnit" value="150" step="0.01">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label>Labor Hours per 100<span class="length-unit-short">m</span></label>
                <input type="number" id="cableLaborHours" value="8" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Cable Trays/Conduits</div>
            <div class="input-row">
              <div class="input-group">
                <label>Length</label>
                <input type="number" id="trayLength" value="300" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label>Cost per Unit</label>
                <input type="number" id="trayCostPerUnit" value="80" step="0.01">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label>Labor Hours per 100<span class="length-unit-short">m</span></label>
                <input type="number" id="trayLaborHours" value="12" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Bus Ducts</div>
            <div class="input-row">
              <div class="input-group">
                <label>Length</label>
                <input type="number" id="busductLength" value="50" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label>Cost per Unit</label>
                <input type="number" id="busductCostPerUnit" value="2000" step="0.01">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label>Labor Hours per 10<span class="length-unit-short">m</span></label>
                <input type="number" id="busductLaborHours" value="16" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Wiring Devices (Outlets, Switches)</div>
            <div class="input-row">
              <div class="input-group">
                <label>Quantity</label>
                <input type="number" id="wiringDeviceQty" value="60" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label>Unit Cost</label>
                <input type="number" id="wiringDeviceUnitCost" value="150" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Labor Hours per Unit</label>
                <input type="number" id="wiringDeviceLaborHours" value="0.25" step="0.1">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="costs-tab">
          <div class="work-item">
            <div class="work-item-title">Direct Costs</div>
            <div class="financial-input-row">
              <div class="input-group">
                <label>Equipment Rental/Mobilization</label>
                <input type="number" id="equipmentCost" value="15000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label>Tools & Consumables</label>
                <input type="number" id="toolsCost" value="5000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
            </div>
          </div>

          <div class="work-item">
            <div class="work-item-title">Indirect Costs</div>
            <div class="financial-input-row">
              <div class="input-group">
                <label>Contingency (%)</label>
                <input type="number" id="contingencyRate" value="10" step="0.1">
              </div>
              <div class="input-group">
                <label>VAT Tax Rate (%)</label>
                <input type="number" id="taxRate" value="12" step="0.1">
              </div>
            </div>
            <div class="financial-input-row">
              <div class="input-group">
                <label>Permits & Fees</label>
                <input type="number" id="permitsCost" value="10000" step="0.01">
                <div class="unit-label">currency</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="help-tab">
          <div class="help-section">
            <h3>How to Use This Calculator</h3>
            <div class="step-guide">
              <p><span class="step-number">1</span> <strong>Project Information:</strong> Enter basic project details including project name, location, and select your preferred unit system and electrical standards.</p>
              <p><span class="step-number">2</span> <strong>Distribution Systems:</strong> Input quantities and costs for main distribution boards (MDBs), sub-main boards (SMDBs), distribution panels, and circuit breakers.</p>
              <p><span class="step-number">3</span> <strong>Cables & Wiring:</strong> Specify lengths and costs for power cables, cable trays/conduits, bus ducts, and wiring devices. Unit system switch automatically converts values.</p>
              <p><span class="step-number">4</span> <strong>Additional Costs:</strong> Configure direct costs (equipment, tools, permits) and indirect costs (contingency, profit margin, VAT).</p>
              <p><span class="step-number">5</span> <strong>Calculate:</strong> Click "Calculate" to generate your cost breakdown and labor requirements.</p>
              <p><span class="step-number">6</span> <strong>Export:</strong> Use the export buttons to save your estimate as PDF or Excel for professional submissions.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="validation-error" id="validationError">
        Please check your inputs. Some values are missing or invalid.
      </div>

      <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; margin-top: 20px;">
        Calculate Estimate
      </button>
    </div>

    <div class="output-section">
      <h2 class="section-title">Estimate Results</h2>

      <div id="resultsPlaceholder">
        <p style="text-align: center; padding: 40px; color: #666; font-style: italic;">
          Enter your project details and click "Calculate" to see results.
        </p>
      </div>

      <div id="resultsContent" class="hidden">
        <h3>Project: <span id="resultProjectName"></span></h3>
        <p><strong>Location:</strong> <span id="resultProjectLocation"></span></p>
        <p><strong>Date:</strong> <span id="resultProjectDate"></span></p>
        <p><strong>Standard:</strong> <span id="resultStandard"></span></p>

        <h4 style="margin-top: 20px;">Bill of Quantity</h4>
        <table class="bill-of-quantity-table" id="billOfQuantityTable">
          <thead>
            <tr>
              <th class="text-center">Item No.</th>
              <th>Scope of Work</th>
              <th class="text-center">Quantity</th>
              <th class="text-center">Unit</th>
              <th class="text-right">Material Cost</th>
              <th class="text-right">Labor Hours</th>
              <th class="text-right">Labor Cost</th>
              <th class="text-right">Total Cost</th>
            </tr>
          </thead>
          <tbody id="billOfQuantityTableBody">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>

        <h4 style="margin-top: 20px;">Summary</h4>
        <table class="bill-of-quantity-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-right">Material Cost</th>
              <th class="text-right">Labor Hours</th>
              <th class="text-right">Labor Cost</th>
              <th class="text-right">Total Cost</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>

        <div class="export-options">
          <button class="btn btn-success" id="saveResultsBtn">Save Results as JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" class="hidden" accept=".json">

<script>
// Global variables
let currentUnitSystem = 'metric';
let currentStandard = 'philippine';
let projectData = {};
const FEET_PER_METER = 3.28084;

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded - initializing calculator');
  
  // Set today's date
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  document.getElementById('projectDate').value = formattedDate;
  
  // Initialize event listeners
  initializeEventListeners();
  
  // Update unit labels
  updateUnitLabels();
});

function initializeEventListeners() {
  // Unit system toggle
  const unitButtons = document.querySelectorAll('.unit-btn');
  unitButtons.forEach(button => {
    button.addEventListener('click', function() {
      const newUnit = this.getAttribute('data-unit');
      console.log('Unit system changed to:', newUnit);
      
      unitButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      if (newUnit !== currentUnitSystem) {
        convertUnits(newUnit);
      }
      currentUnitSystem = newUnit;
      updateUnitLabels();
    });
  });

  // Standard toggle
  const standardButtons = document.querySelectorAll('.standard-btn');
  standardButtons.forEach(button => {
    button.addEventListener('click', function() {
      const newStandard = this.getAttribute('data-standard');
      console.log('Standard changed to:', newStandard);
      
      standardButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      currentStandard = newStandard;
      updateStandards();
    });
  });

  // Tab navigation
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      console.log('Tab clicked:', tabId);
      
      // Remove active class from all tabs and contents
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      this.classList.add('active');
      const targetContent = document.getElementById(tabId + '-tab');
      if (targetContent) {
        targetContent.classList.add('active');
      }
    });
  });

  // Calculate button
  const calculateBtn = document.getElementById('calculateBtn');
  calculateBtn.addEventListener('click', function() {
    console.log('Calculate button clicked');
    calculateEstimate();
  });

  // Other buttons
  document.getElementById('saveBtn').addEventListener('click', saveProject);
  document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', loadProject);
  document.getElementById('resetBtn').addEventListener('click', resetCalculator);
  document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
  document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
  document.getElementById('saveResultsBtn').addEventListener('click', saveResultsAsJson);
}

// Utility functions
function safeNumber(v, fallback = 0) {
  if (v === '' || v === null || v === undefined) return fallback;
  const n = Number(v);
  return isNaN(n) ? fallback : n;
}

function formatNumber(num, dp = 2) {
  if (typeof num !== 'number' || isNaN(num)) return "0.00";
  const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
  return rounded.toLocaleString(undefined, { 
    minimumFractionDigits: dp, 
    maximumFractionDigits: dp 
  });
}

function formatCurrency(n) {
  if (typeof n !== 'number' || isNaN(n)) return "P 0.00";
  const c = document.getElementById('currency').value;
  const symbol = c === 'PHP' ? 'P' : (c === 'USD' ? '$' : (c === 'EUR' ? '€' : '¥'));
  return symbol + ' ' + formatNumber(n, 2);
}

function updateUnitLabels() {
  const lengthUnit = currentUnitSystem === 'metric' ? 'meters' : 'feet';
  const lengthUnitShort = currentUnitSystem === 'metric' ? 'm' : 'ft';
  
  document.querySelectorAll('.length-unit').forEach(unit => {
    unit.textContent = lengthUnit;
  });
  
  document.querySelectorAll('.length-unit-short').forEach(unit => {
    unit.textContent = lengthUnitShort;
  });
}

function convertUnits(newUnit) {
  const factor = (newUnit === 'imperial' && currentUnitSystem === 'metric') ? FEET_PER_METER :
    (newUnit === 'metric' && currentUnitSystem === 'imperial') ? 1 / FEET_PER_METER : 1;
  
  if (factor === 1) return;

  // Convert length fields
  const lengthIds = ['cableLength', 'trayLength', 'busductLength'];
  lengthIds.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.value = formatNumber(safeNumber(input.value) * factor, 1);
    }
  });
}

function updateStandards() {
  const laborRateInput = document.getElementById('laborRate');
  const taxRateInput = document.getElementById('taxRate');
  
  if (currentStandard === 'philippine') {
    laborRateInput.value = '250';
    taxRateInput.value = '12';
  } else {
    laborRateInput.value = '45';
    taxRateInput.value = '0';
  }
}

function calculateEstimate() {
  console.log('Starting calculation...');
  
  // Get input values
  const laborRate = safeNumber(document.getElementById('laborRate').value);
  const overheadRate = safeNumber(document.getElementById('overheadRate').value) / 100;
  const profitMarginRate = safeNumber(document.getElementById('profitMarginRate').value) / 100;
  const contingencyRate = safeNumber(document.getElementById('contingencyRate').value) / 100;
  const taxRate = safeNumber(document.getElementById('taxRate').value) / 100;
  
  const equipmentCost = safeNumber(document.getElementById('equipmentCost').value);
  const toolsCost = safeNumber(document.getElementById('toolsCost').value);
  const permitsCost = safeNumber(document.getElementById('permitsCost').value);

  // Calculate work items
  const workItems = [
    {
      name: 'Main Distribution Boards (MDBs)',
      quantity: safeNumber(document.getElementById('mdbQty').value),
      unitCost: safeNumber(document.getElementById('mdbUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('mdbLaborHours').value)
    },
    {
      name: 'Sub-Main Distribution Boards (SMDBs)',
      quantity: safeNumber(document.getElementById('smdbQty').value),
      unitCost: safeNumber(document.getElementById('smdbUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('smdbLaborHours').value)
    },
    {
      name: 'Distribution Panels',
      quantity: safeNumber(document.getElementById('panelQty').value),
      unitCost: safeNumber(document.getElementById('panelUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('panelLaborHours').value)
    },
    {
      name: 'Circuit Breakers',
      quantity: safeNumber(document.getElementById('breakerQty').value),
      unitCost: safeNumber(document.getElementById('breakerUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('breakerLaborHours').value)
    },
    {
      name: 'Power Cables',
      quantity: safeNumber(document.getElementById('cableLength').value),
      unitCost: safeNumber(document.getElementById('cableCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('cableLaborHours').value) / 100
    },
    {
      name: 'Cable Trays/Conduits',
      quantity: safeNumber(document.getElementById('trayLength').value),
      unitCost: safeNumber(document.getElementById('trayCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('trayLaborHours').value) / 100
    },
    {
      name: 'Bus Ducts',
      quantity: safeNumber(document.getElementById('busductLength').value),
      unitCost: safeNumber(document.getElementById('busductCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('busductLaborHours').value) / 10
    },
    {
      name: 'Wiring Devices',
      quantity: safeNumber(document.getElementById('wiringDeviceQty').value),
      unitCost: safeNumber(document.getElementById('wiringDeviceUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('wiringDeviceLaborHours').value)
    }
  ];

  // Calculate totals
  let totalMaterialCost = 0;
  let totalLaborHours = 0;
  let totalLaborCost = 0;

  workItems.forEach(item => {
    item.materialCost = item.quantity * item.unitCost;
    item.laborHours = item.quantity * item.laborHoursPerUnit;
    item.laborCost = item.laborHours * laborRate;
    item.totalCost = item.materialCost + item.laborCost;

    totalMaterialCost += item.materialCost;
    totalLaborHours += item.laborHours;
    totalLaborCost += item.laborCost;
  });

  // Add direct costs
  const totalDirectCost = totalMaterialCost + totalLaborCost + equipmentCost + toolsCost;

  // Calculate indirect costs
  const overheadCost = totalDirectCost * overheadRate;
  const contingencyCost = totalDirectCost * contingencyRate;
  const totalIndirectCost = overheadCost + contingencyCost + permitsCost;

  // Calculate profit and tax
  const costBeforeProfit = totalDirectCost + totalIndirectCost;
  const profit = costBeforeProfit * profitMarginRate;
  const totalBeforeTax = costBeforeProfit + profit;
  const tax = totalBeforeTax * taxRate;
  const finalPrice = totalBeforeTax + tax;

  // Store results
  projectData = {
    projectName: document.getElementById('projectName').value || 'Unnamed Project',
    projectLocation: document.getElementById('projectLocation').value,
    projectDate: document.getElementById('projectDate').value,
    unitSystem: currentUnitSystem,
    standard: currentStandard,
    currency: document.getElementById('currency').value,
    workItems: workItems,
    totals: {
      totalMaterialCost,
      totalLaborHours,
      totalLaborCost,
      totalDirectCost,
      overheadCost,
      contingencyCost,
      totalIndirectCost,
      costBeforeProfit,
      profit,
      tax,
      finalPrice
    }
  };

  // Display results
  displayResults();
  console.log('Calculation completed successfully');
}

function displayResults() {
  const resultsContent = document.getElementById('resultsContent');
  const resultsPlaceholder = document.getElementById('resultsPlaceholder');
  
  // Update project info
  document.getElementById('resultProjectName').textContent = projectData.projectName;
  document.getElementById('resultProjectLocation').textContent = projectData.projectLocation || 'Not specified';
  document.getElementById('resultProjectDate').textContent = projectData.projectDate || 'Not specified';
  document.getElementById('resultStandard').textContent = projectData.standard === 'philippine' ? 'Philippine Electrical Code (PEC)' : 'International (IEC)';

  // Update bill of quantity table
  const billOfQuantityTableBody = document.getElementById('billOfQuantityTableBody');
  billOfQuantityTableBody.innerHTML = '';

  let itemNo = 1;
  projectData.workItems.forEach(item => {
    if (item.quantity > 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="text-center">${itemNo++}</td>
        <td>${item.name}</td>
        <td class="text-center">${formatNumber(item.quantity)}</td>
        <td class="text-center">${currentUnitSystem === 'metric' ? 'm' : 'ft'}</td>
        <td class="text-right">${formatCurrency(item.materialCost)}</td>
        <td class="text-right">${formatNumber(item.laborHours, 1)}</td>
        <td class="text-right">${formatCurrency(item.laborCost)}</td>
        <td class="text-right">${formatCurrency(item.totalCost)}</td>
      `;
      billOfQuantityTableBody.appendChild(row);
    }
  });

  // Add equipment and tools
  const equipmentCost = safeNumber(document.getElementById('equipmentCost').value);
  const toolsCost = safeNumber(document.getElementById('toolsCost').value);
  
  if (equipmentCost > 0) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="text-center">${itemNo++}</td>
      <td>Equipment Rental/Mobilization</td>
      <td class="text-center">1</td>
      <td class="text-center">lot</td>
      <td class="text-right">${formatCurrency(equipmentCost)}</td>
      <td class="text-right">-</td>
      <td class="text-right">-</td>
      <td class="text-right">${formatCurrency(equipmentCost)}</td>
    `;
    billOfQuantityTableBody.appendChild(row);
  }

  if (toolsCost > 0) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="text-center">${itemNo++}</td>
      <td>Tools & Consumables</td>
      <td class="text-center">1</td>
      <td class="text-center">lot</td>
      <td class="text-right">${formatCurrency(toolsCost)}</td>
      <td class="text-right">-</td>
      <td class="text-right">-</td>
      <td class="text-right">${formatCurrency(toolsCost)}</td>
    `;
    billOfQuantityTableBody.appendChild(row);
  }

  // Update summary table
  const summaryTableBody = document.getElementById('summaryTableBody');
  summaryTableBody.innerHTML = '';

  const summaryData = [
    { label: 'Materials', material: projectData.totals.totalMaterialCost, laborHours: 0, labor: 0, total: projectData.totals.totalMaterialCost },
    { label: 'Labor', material: 0, laborHours: projectData.totals.totalLaborHours, labor: projectData.totals.totalLaborCost, total: projectData.totals.totalLaborCost },
    { label: 'Equipment & Tools', material: equipmentCost + toolsCost, laborHours: 0, labor: 0, total: equipmentCost + toolsCost },
    { label: 'Direct Costs Subtotal', material: projectData.totals.totalMaterialCost + equipmentCost + toolsCost, laborHours: projectData.totals.totalLaborHours, labor: projectData.totals.totalLaborCost, total: projectData.totals.totalDirectCost },
    { label: 'Overhead & Contingency', material: projectData.totals.overheadCost + projectData.totals.contingencyCost, laborHours: 0, labor: 0, total: projectData.totals.overheadCost + projectData.totals.contingencyCost },
    { label: 'Permits & Fees', material: safeNumber(document.getElementById('permitsCost').value), laborHours: 0, labor: 0, total: safeNumber(document.getElementById('permitsCost').value) },
    { label: 'Profit', material: projectData.totals.profit, laborHours: 0, labor: 0, total: projectData.totals.profit },
    { label: 'VAT Tax', material: projectData.totals.tax, laborHours: 0, labor: 0, total: projectData.totals.tax }
  ];

  summaryData.forEach(item => {
    const row = document.createElement('tr');
    if (item.label.includes('Subtotal') || item.label.includes('FINAL')) {
      row.className = 'total-row';
    }
    row.innerHTML = `
      <td>${item.label}</td>
      <td class="text-right">${item.material > 0 ? formatCurrency(item.material) : '-'}</td>
      <td class="text-right">${item.laborHours > 0 ? formatNumber(item.laborHours, 1) : '-'}</td>
      <td class="text-right">${item.labor > 0 ? formatCurrency(item.labor) : '-'}</td>
      <td class="text-right">${formatCurrency(item.total)}</td>
    `;
    summaryTableBody.appendChild(row);
  });

  // Add final price row
  const finalRow = document.createElement('tr');
  finalRow.className = 'total-row';
  finalRow.innerHTML = `
    <td><strong>FINAL PRICE</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>${formatCurrency(projectData.totals.finalPrice)}</strong></td>
  `;
  summaryTableBody.appendChild(finalRow);

  // Show results
  resultsPlaceholder.classList.add('hidden');
  resultsContent.classList.remove('hidden');
}

// Other functions (simplified for demo)
function saveProject() {
  alert('Save functionality would be implemented here');
}

function loadProject(event) {
  alert('Load functionality would be implemented here');
}

function resetCalculator() {
  if (confirm('Are you sure you want to reset all inputs?')) {
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.value = input.getAttribute('value') || '0';
    });
    document.getElementById('projectName').value = 'Sample Project';
    document.getElementById('projectLocation').value = 'Manila, Philippines';
    
    document.getElementById('resultsContent').classList.add('hidden');
    document.getElementById('resultsPlaceholder').classList.remove('hidden');
  }
}

function exportToPdf() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  alert('PDF export functionality would be implemented here');
}

function exportToExcel() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  alert('Excel export functionality would be implemented here');
}

function saveResultsAsJson() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  alert('JSON save functionality would be implemented here');
}
</script>
</body>
</html>
